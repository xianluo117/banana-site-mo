<!DOCTYPE html>
<html lang="zh-CN">
<head>

<script class="injected-ffc2e83d85">
(function(){'use strict';function q(b){var c=0;return function(){return c<b.length?{done:!1,value:b[c++]}:{done:!0}}}function t(b){var c=typeof Symbol!="undefined"&&Symbol.iterator&&b[Symbol.iterator];if(c)return c.call(b);if(typeof b.length=="number")return{next:q(b)};throw Error(String(b)+" is not an iterable or ArrayLike");}var u=typeof Object.defineProperties=="function"?Object.defineProperty:function(b,c,g){if(b==Array.prototype||b==Object.prototype)return b;b[c]=g.value;return b};
function v(b){b=["object"==typeof globalThis&&globalThis,b,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var c=0;c<b.length;++c){var g=b[c];if(g&&g.Math==Math)return g}throw Error("Cannot find global object");}var w=v(this);function x(b,c){if(c)a:{var g=w;b=b.split(".");for(var h=0;h<b.length-1;h++){var l=b[h];if(!(l in g))break a;g=g[l]}b=b[b.length-1];h=g[b];c=c(h);c!=h&&c!=null&&u(g,b,{configurable:!0,writable:!0,value:c})}}
function y(){this.j=!1;this.g=null;this.u=void 0;this.h=1;this.v=this.l=0;this.i=null}function z(b){if(b.j)throw new TypeError("Generator is already running");b.j=!0}y.prototype.o=function(b){this.u=b};function A(b,c){b.i={I:c,J:!0};b.h=b.l||b.v}y.prototype.return=function(b){this.i={return:b};this.h=this.v};function B(b){this.g=new y;this.h=b}function E(b,c){z(b.g);var g=b.g.g;if(g)return F(b,"return"in g?g["return"]:function(h){return{value:h,done:!0}},c,b.g.return);b.g.return(c);return G(b)}
function F(b,c,g,h){try{var l=c.call(b.g.g,g);if(!(l instanceof Object))throw new TypeError("Iterator result "+l+" is not an object");if(!l.done)return b.g.j=!1,l;var m=l.value}catch(f){return b.g.g=null,A(b.g,f),G(b)}b.g.g=null;h.call(b.g,m);return G(b)}function G(b){for(;b.g.h;)try{var c=b.h(b.g);if(c)return b.g.j=!1,{value:c.value,done:!1}}catch(g){b.g.u=void 0,A(b.g,g)}b.g.j=!1;if(b.g.i){c=b.g.i;b.g.i=null;if(c.J)throw c.I;return{value:c.return,done:!0}}return{value:void 0,done:!0}}
function H(b){this.next=function(c){z(b.g);b.g.g?c=F(b,b.g.g.next,c,b.g.o):(b.g.o(c),c=G(b));return c};this.throw=function(c){z(b.g);b.g.g?c=F(b,b.g.g["throw"],c,b.g.o):(A(b.g,c),c=G(b));return c};this.return=function(c){return E(b,c)};this[Symbol.iterator]=function(){return this}}function I(b){function c(h){return b.next(h)}function g(h){return b.throw(h)}return new Promise(function(h,l){function m(f){f.done?h(f.value):Promise.resolve(f.value).then(c,g).then(m,l)}m(b.next())})}
x("Symbol",function(b){function c(m){if(this instanceof c)throw new TypeError("Symbol is not a constructor");return new g(h+(m||"")+"_"+l++,m)}function g(m,f){this.g=m;u(this,"description",{configurable:!0,writable:!0,value:f})}if(b)return b;g.prototype.toString=function(){return this.g};var h="jscomp_symbol_"+(Math.random()*1E9>>>0)+"_",l=0;return c});
x("Symbol.iterator",function(b){if(b)return b;b=Symbol("Symbol.iterator");u(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return J(q(this))}});return b});function J(b){b={next:b};b[Symbol.iterator]=function(){return this};return b}
x("Promise",function(b){function c(f){this.h=0;this.i=void 0;this.g=[];this.u=!1;var a=this.j();try{f(a.resolve,a.reject)}catch(d){a.reject(d)}}function g(){this.g=null}function h(f){return f instanceof c?f:new c(function(a){a(f)})}if(b)return b;g.prototype.h=function(f){if(this.g==null){this.g=[];var a=this;this.i(function(){a.l()})}this.g.push(f)};var l=w.setTimeout;g.prototype.i=function(f){l(f,0)};g.prototype.l=function(){for(;this.g&&this.g.length;){var f=this.g;this.g=[];for(var a=0;a<f.length;++a){var d=
f[a];f[a]=null;try{d()}catch(e){this.j(e)}}}this.g=null};g.prototype.j=function(f){this.i(function(){throw f;})};c.prototype.j=function(){function f(e){return function(k){d||(d=!0,e.call(a,k))}}var a=this,d=!1;return{resolve:f(this.D),reject:f(this.l)}};c.prototype.D=function(f){if(f===this)this.l(new TypeError("A Promise cannot resolve to itself"));else if(f instanceof c)this.G(f);else{a:switch(typeof f){case "object":var a=f!=null;break a;case "function":a=!0;break a;default:a=!1}a?this.C(f):this.o(f)}};
c.prototype.C=function(f){var a=void 0;try{a=f.then}catch(d){this.l(d);return}typeof a=="function"?this.H(a,f):this.o(f)};c.prototype.l=function(f){this.v(2,f)};c.prototype.o=function(f){this.v(1,f)};c.prototype.v=function(f,a){if(this.h!=0)throw Error("Cannot settle("+f+", "+a+"): Promise already settled in state"+this.h);this.h=f;this.i=a;this.h===2&&this.F();this.K()};c.prototype.F=function(){var f=this;l(function(){if(f.B()){var a=w.console;typeof a!=="undefined"&&a.error(f.i)}},1)};c.prototype.B=
function(){if(this.u)return!1;var f=w.CustomEvent,a=w.Event,d=w.dispatchEvent;if(typeof d==="undefined")return!0;typeof f==="function"?f=new f("unhandledrejection",{cancelable:!0}):typeof a==="function"?f=new a("unhandledrejection",{cancelable:!0}):(f=w.document.createEvent("CustomEvent"),f.initCustomEvent("unhandledrejection",!1,!0,f));f.promise=this;f.reason=this.i;return d(f)};c.prototype.K=function(){if(this.g!=null){for(var f=0;f<this.g.length;++f)m.h(this.g[f]);this.g=null}};var m=new g;c.prototype.G=
function(f){var a=this.j();f.A(a.resolve,a.reject)};c.prototype.H=function(f,a){var d=this.j();try{f.call(a,d.resolve,d.reject)}catch(e){d.reject(e)}};c.prototype.then=function(f,a){function d(n,r){return typeof n=="function"?function(C){try{e(n(C))}catch(D){k(D)}}:r}var e,k,p=new c(function(n,r){e=n;k=r});this.A(d(f,e),d(a,k));return p};c.prototype.catch=function(f){return this.then(void 0,f)};c.prototype.A=function(f,a){function d(){switch(e.h){case 1:f(e.i);break;case 2:a(e.i);break;default:throw Error("Unexpected state: "+
e.h);}}var e=this;this.g==null?m.h(d):this.g.push(d);this.u=!0};c.resolve=h;c.reject=function(f){return new c(function(a,d){d(f)})};c.race=function(f){return new c(function(a,d){for(var e=t(f),k=e.next();!k.done;k=e.next())h(k.value).A(a,d)})};c.all=function(f){var a=t(f),d=a.next();return d.done?h([]):new c(function(e,k){function p(C){return function(D){n[C]=D;r--;r==0&&e(n)}}var n=[],r=0;do n.push(void 0),r++,h(d.value).A(p(n.length-1),k),d=a.next();while(!d.done)})};return c});
function K(b,c){return Object.prototype.hasOwnProperty.call(b,c)}x("Object.is",function(b){return b?b:function(c,g){return c===g?c!==0||1/c===1/g:c!==c&&g!==g}});x("Array.prototype.includes",function(b){return b?b:function(c,g){var h=this;h instanceof String&&(h=String(h));var l=h.length;g=g||0;for(g<0&&(g=Math.max(g+l,0));g<l;g++){var m=h[g];if(m===c||Object.is(m,c))return!0}return!1}});
x("String.prototype.includes",function(b){return b?b:function(c,g){if(this==null)throw new TypeError("The 'this' value for String.prototype.includes must not be null or undefined");if(c instanceof RegExp)throw new TypeError("First argument to String.prototype.includes must not be a regular expression");return this.indexOf(c,g||0)!==-1}});
x("WeakMap",function(b){function c(d){this.g=(a+=Math.random()+1).toString();if(d){d=t(d);for(var e;!(e=d.next()).done;)e=e.value,this.set(e[0],e[1])}}function g(){}function h(d){var e=typeof d;return e==="object"&&d!==null||e==="function"}function l(d){if(!K(d,f)){var e=new g;u(d,f,{value:e})}}function m(d){var e=Object[d];e&&(Object[d]=function(k){if(k instanceof g)return k;Object.isExtensible(k)&&l(k);return e(k)})}if(function(){if(!b||!Object.seal)return!1;try{var d=Object.seal({}),e=Object.seal({}),
k=new b([[d,2],[e,3]]);if(k.get(d)!=2||k.get(e)!=3)return!1;k.delete(d);k.set(e,4);return!k.has(d)&&k.get(e)==4}catch(p){return!1}}())return b;var f="$jscomp_hidden_"+Math.random();m("freeze");m("preventExtensions");m("seal");var a=0;c.prototype.set=function(d,e){if(!h(d))throw Error("Invalid WeakMap key");l(d);if(!K(d,f))throw Error("WeakMap key fail: "+d);d[f][this.g]=e;return this};c.prototype.get=function(d){return h(d)&&K(d,f)?d[f][this.g]:void 0};c.prototype.has=function(d){return h(d)&&K(d,
f)&&K(d[f],this.g)};c.prototype.delete=function(d){return h(d)&&K(d,f)&&K(d[f],this.g)?delete d[f][this.g]:!1};return c});
x("Map",function(b){function c(){var a={};return a.m=a.next=a.head=a}function g(a,d){var e=a[1];return J(function(){if(e){for(;e.head!=a[1];)e=e.m;for(;e.next!=e.head;)return e=e.next,{done:!1,value:d(e)};e=null}return{done:!0,value:void 0}})}function h(a,d){var e=d&&typeof d;e=="object"||e=="function"?m.has(d)?e=m.get(d):(e=""+ ++f,m.set(d,e)):e="p_"+d;var k=a[0][e];if(k&&K(a[0],e))for(a=0;a<k.length;a++){var p=k[a];if(d!==d&&p.key!==p.key||d===p.key)return{id:e,list:k,index:a,entry:p}}return{id:e,
list:k,index:-1,entry:void 0}}function l(a){this[0]={};this[1]=c();this.size=0;if(a){a=t(a);for(var d;!(d=a.next()).done;)d=d.value,this.set(d[0],d[1])}}if(function(){if(!b||typeof b!="function"||!b.prototype.entries||typeof Object.seal!="function")return!1;try{var a=Object.seal({x:4}),d=new b(t([[a,"s"]]));if(d.get(a)!="s"||d.size!=1||d.get({x:4})||d.set({x:4},"t")!=d||d.size!=2)return!1;var e=d.entries(),k=e.next();if(k.done||k.value[0]!=a||k.value[1]!="s")return!1;k=e.next();return k.done||k.value[0].x!=
4||k.value[1]!="t"||!e.next().done?!1:!0}catch(p){return!1}}())return b;var m=new WeakMap;l.prototype.set=function(a,d){a=a===0?0:a;var e=h(this,a);e.list||(e.list=this[0][e.id]=[]);e.entry?e.entry.value=d:(e.entry={next:this[1],m:this[1].m,head:this[1],key:a,value:d},e.list.push(e.entry),this[1].m.next=e.entry,this[1].m=e.entry,this.size++);return this};l.prototype.delete=function(a){a=h(this,a);return a.entry&&a.list?(a.list.splice(a.index,1),a.list.length||delete this[0][a.id],a.entry.m.next=a.entry.next,
a.entry.next.m=a.entry.m,a.entry.head=null,this.size--,!0):!1};l.prototype.clear=function(){this[0]={};this[1]=this[1].m=c();this.size=0};l.prototype.has=function(a){return!!h(this,a).entry};l.prototype.get=function(a){return(a=h(this,a).entry)&&a.value};l.prototype.entries=function(){return g(this,function(a){return[a.key,a.value]})};l.prototype.keys=function(){return g(this,function(a){return a.key})};l.prototype.values=function(){return g(this,function(a){return a.value})};l.prototype.forEach=
function(a,d){for(var e=this.entries(),k;!(k=e.next()).done;)k=k.value,a.call(d,k[1],k[0],this)};l.prototype[Symbol.iterator]=l.prototype.entries;var f=0;return l});
x("Set",function(b){function c(g){this.g=new Map;if(g){g=t(g);for(var h;!(h=g.next()).done;)this.add(h.value)}this.size=this.g.size}if(function(){if(!b||typeof b!="function"||!b.prototype.entries||typeof Object.seal!="function")return!1;try{var g=Object.seal({x:4}),h=new b(t([g]));if(!h.has(g)||h.size!=1||h.add(g)!=h||h.size!=1||h.add({x:4})!=h||h.size!=2)return!1;var l=h.entries(),m=l.next();if(m.done||m.value[0]!=g||m.value[1]!=g)return!1;m=l.next();return m.done||m.value[0]==g||m.value[0].x!=4||
m.value[1]!=m.value[0]?!1:l.next().done}catch(f){return!1}}())return b;c.prototype.add=function(g){g=g===0?0:g;this.g.set(g,g);this.size=this.g.size;return this};c.prototype.delete=function(g){g=this.g.delete(g);this.size=this.g.size;return g};c.prototype.clear=function(){this.g.clear();this.size=0};c.prototype.has=function(g){return this.g.has(g)};c.prototype.entries=function(){return this.g.entries()};c.prototype.values=function(){return this.g.values()};c.prototype.keys=c.prototype.values;c.prototype[Symbol.iterator]=
c.prototype.values;c.prototype.forEach=function(g,h){var l=this;this.g.forEach(function(m){return g.call(h,m,m,l)})};return c});(function(){function b(){return m?Promise.resolve(m):f?f:f=fetch("https://www.gstatic.com/bard-maui/resources/material-design-icon-names.804824289.json").then(function(a){if(!a.ok)throw Error("HTTP error! status: "+a.status+" fetching https://www.gstatic.com/bard-maui/resources/material-design-icon-names.804824289.json");return a.json()}).then(function(a){if(!Array.isArray(a))throw new TypeError("Fetched icon names from https://www.gstatic.com/bard-maui/resources/material-design-icon-names.804824289.json is not an array.");
return m=a}).catch(function(a){console.error("IconChecker: Failed to load valid icon names from https://www.gstatic.com/bard-maui/resources/material-design-icon-names.804824289.json.",a);f=null;throw a;})}function c(a){var d,e,k,p;return I(new H(new B(function(n){switch(n.h){case 1:d=(a.textContent||"").trim();if(!d||a.classList.contains("js-replaced-missing-icon")&&d==="radio_button_unchecked")return n.return();e=window.getComputedStyle(a);if(e.display==="none"||e.visibility==="hidden")return n.return();
n.l=2;var r=b();n.h=4;return{value:r};case 4:k=n.u;n.h=3;n.l=0;break;case 2:return n.l=0,n.i=null,console.warn('IconChecker: Skipping check for icon "'+d+'" as valid names could not be loaded.'),n.return();case 3:(p=k.includes(d))?a.classList.contains("js-replaced-missing-icon")&&a.classList.remove("js-replaced-missing-icon"):d==="radio_button_unchecked"&&a.classList.contains("js-replaced-missing-icon")||(a.textContent="radio_button_unchecked",a.classList.add("js-replaced-missing-icon")),n.h=0}})))}
function g(a){a=a===void 0?document.body:a;a.querySelectorAll(l).forEach(function(d){c(d)})}function h(){b().catch(function(){});document.fonts.ready.then(function(){requestAnimationFrame(function(){g(document.body);(new MutationObserver(function(a){var d=new Set;a=t(a);for(var e=a.next();!e.done;e=a.next())if(e=e.value,e.type==="childList")e.addedNodes.forEach(function(p){p.nodeType===Node.ELEMENT_NODE&&(p.matches(l)&&d.add(p),p.querySelectorAll(l).forEach(function(n){d.add(n)}))});else if(e.type===
"attributes"&&e.attributeName==="class"){var k=e.target;e.target.nodeType===Node.ELEMENT_NODE&&k.matches(l)&&d.add(k)}else e.type==="characterData"&&e.target.parentNode&&(e=e.target.parentNode,e.nodeType===Node.ELEMENT_NODE&&e.matches(l)&&d.add(e));d.size>0&&setTimeout(function(){d.forEach(function(p){c(p)})},500)})).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"],characterData:!0})})}).catch(function(a){console.error("IconChecker: Font loading error. Scanning icons anyway.",
a);requestAnimationFrame(function(){g(document.body)})})}var l=["material-icons","material-symbols-outlined","material-symbols-rounded","material-symbols-sharp"].map(function(a){return"."+a}).join(","),m=null,f=null;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",function(){h()}):h()})();}).call(this);

</script>

    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Gemini Pro 工作台 v 修改版</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        mono: ['JetBrains Mono', 'Menlo', 'monospace'], 
                        sans: ['Inter', 'system-ui', 'sans-serif'] 
                    },
                    colors: {
                        gray: { 850: '#1f2937', 900: '#111827', 950: '#0b0f19' },
                    },
                    animation: {
                        'slide-in': 'slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'bounce-in': 'bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { transform: 'translateX(100%)' },
                            '100%': { transform: 'translateX(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <!-- Icons & Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&amp;family=JetBrains+Mono:wght@400;500&amp;display=swap" rel="stylesheet"/>
    
    <!-- Markdown & Highlight -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- JSZip for Batch Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        body { background-color: #0b0f19; color: #cbd5e1; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        html:not(.dark) body { background-color: #ffffff; color: #111827; }
        /* Black & White */
        html.bw { filter: grayscale(100%); }

        /* Light theme overrides to counter fixed dark utility classes */
        html:not(.dark) main { background-color: #ffffff !important; background-image: radial-gradient(circle at top right, rgba(241,245,249,0.6), transparent 50%) !important; }
        html:not(.dark) header { background-color: rgba(255,255,255,0.8) !important; border-color: #e5e7eb !important; }
        html:not(.dark) #leftSidebar { background-color: #ffffff !important; border-color: #e5e7eb !important; }
        html:not(.dark) #chatDrawer { background-color: #ffffff !important; }
        html:not(.dark) .glass-panel { background: rgba(255,255,255,0.7) !important; border-color: rgba(229,231,235,0.8) !important; }
        html:not(.dark) .input-dark { background-color: #f9fafb !important; border-color: #e5e7eb !important; color: #111827 !important; }
        html:not(.dark) .input-dark:focus { background-color: #ffffff !important; border-color: #3b82f6 !important; box-shadow: 0 0 0 1px rgba(59,130,246,0.3) !important; }
        html:not(.dark) .prose pre { background: #f6f8fa !important; border-color: #e5e7eb !important; }
        html:not(.dark) .prose code { color: #111827 !important; }
        /* prose-invert content back to light mode */
        html:not(.dark) .prose-invert { color: #111827 !important; }
        html:not(.dark) .prose-invert pre { background: #f6f8fa !important; border-color: #e5e7eb !important; }
        html:not(.dark) .prose-invert code { color: #111827 !important; }

        /* Make modal panels light while keeping black overlays as-is */
        html:not(.dark) #configModal > div,
        html:not(.dark) #collectionsModal > div,
        html:not(.dark) #promptModal > div,
        html:not(.dark) #rawModal > div { background-color: #ffffff !important; }

        /* Generic overrides for arbitrary dark bg/border/text utilities */
        html:not(.dark) [class*="bg-[#0b0f19]"],
        html:not(.dark) [class*="bg-[#0f1219]"],
        html:not(.dark) [class*="bg-[#0d1117]"],
        html:not(.dark) [class*="bg-[#111827]"],
        html:not(.dark) [class*="bg-[#161b26]"],
        html:not(.dark) [class*="bg-[#080b12]"],
        html:not(.dark) [class*="bg-[#1f2937]"],
        html:not(.dark) [class*="bg-gray-900"],
        html:not(.dark) [class*="bg-gray-800"],
        html:not(.dark) [class*="bg-gray-700"],
        html:not(.dark) [class*="bg-gray-600"] { background-color: #ffffff !important; }

        html:not(.dark) [class*="border-gray-900"],
        html:not(.dark) [class*="border-gray-800"],
        html:not(.dark) [class*="border-gray-700"],
        html:not(.dark) [class*="border-gray-600"] { border-color: #e5e7eb !important; }

        html:not(.dark) [class*="text-gray-200"],
        html:not(.dark) [class*="text-gray-300"],
        html:not(.dark) [class*="text-gray-400"] { color: #111827 !important; }
        html:not(.dark) [class*="text-gray-500"] { color: #374151 !important; }
        html:not(.dark) .bg-gray-700[type="range"] { background-color: #e5e7eb !important; }

        /* Light content surfaces that used translucent black backgrounds */
        html:not(.dark) [class*="bg-black/20"],
        html:not(.dark) [class*="bg-black/30"],
        html:not(.dark) [class*="bg-black/60"] { background-color: #ffffff !important; }

        /* Keep heavy overlays dark in light theme */
        html:not(.dark) #lightbox { background-color: rgba(0,0,0,0.95) !important; }
        html:not(.dark) #mobileSidebarBackdrop { background-color: rgba(0,0,0,0.60) !important; }
        html:not(.dark) #dragOverlay { background-color: rgba(59,130,246,0.1) !important; }
        html:not(.dark) #lightbox button { color: #111827 !important; background-color: rgba(255,255,255,0.8) !important; }
        html:not(.dark) .text-red-200 { color: #dc2626 !important; /* Deeper red for light mode errors */ }

        /* Stopped state banners (dark + light) */
        .stopped-banner {
            background-color: rgba(251, 191, 36, 0.10);
            border: 1px solid rgba(252, 211, 77, 0.70);
            color: #FDE68A;
        }
        html:not(.dark) .stopped-banner {
            background-color: #FEF3C7;
            border-color: #F59E0B;
            color: #92400E !important;
        }
        html:not(.dark) .stopped-status {
            color: #b45309 !important;
        }

        /* Fix image preview hover in light mode */
        html:not(.dark) #previewStrip .group:hover button { background-color: rgba(0,0,0,0.5) !important; color: #ffffff !important; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Glass & Inputs */
        .glass-panel {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(55, 65, 81, 0.5);
        }
        .input-dark {
            background-color: rgba(31, 41, 55, 0.5);
            border: 1px solid #374151;
            color: #e2e8f0;
            transition: all 0.2s;
        }
        .input-dark:focus {
            border-color: #3b82f6;
            background-color: rgba(31, 41, 55, 0.9);
            outline: none;
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3);
        }

        /* Checkbox Custom */
        .custom-checkbox {
            appearance: none;
            background-color: rgba(31, 41, 55, 0.5);
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.15em;
            height: 1.15em;
            border: 1px solid #4b5563;
            border-radius: 0.25em;
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-checkbox::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white;
            background-color: white;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .custom-checkbox:checked::before {
            transform: scale(1);
        }

        /* Markdown */
        .prose { font-size: 0.9rem; line-height: 1.6; }
        .prose pre { background: #0d1117 !important; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #30363d; margin: 0.5rem 0; overflow-x: auto; }
        .prose code { font-family: 'JetBrains Mono', monospace; color: #e2e8f0; }
        .prose p { margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; padding-left: 1.2rem; margin-bottom: 0.5rem; }

        /* Drag Overlay */
        #dragOverlay {
            pointer-events: none;
            background: rgba(59, 130, 246, 0.1);
            border: 2px dashed #3b82f6;
            backdrop-filter: blur(4px);
        }
        
        /* Builder Drop Zone Active State */
        .builder-drop-active {
            border-color: #3b82f6 !important;
            background-color: rgba(59, 130, 246, 0.05) !important;
        }

        .line-clamp-6 {
            display: -webkit-box;
            -webkit-line-clamp: 6;
            -webkit-box-orient: vertical;
            line-clamp: 6;
            overflow: hidden;
        }
        textarea { field-sizing: content; }

        .aspect-ratio-preview {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 6px;
            flex-shrink: 0;
        }
        .aspect-ratio-preview > div {
            background-color: #9ca3af;
            border-radius: 1px;
            transition: background-color 0.2s;
        }
        html:not(.dark) .aspect-ratio-preview > div {
            background-color: #6b7280;
        }
        button[aria-pressed="true"] .aspect-ratio-preview > div {
            background-color: white;
        }
        /* Mobile Safe Area */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Card size presets for session panels */
        .card-size-sm {
            height: 280px;
        }
        @media (min-width: 768px) {
            .card-size-sm {
                height: 340px;
            }
        }
        .card-size-md {
            height: 380px;
        }
        @media (min-width: 768px) {
            .card-size-md {
                height: 500px;
            }
        }
        .card-size-lg {
            height: 460px;
        }
        @media (min-width: 768px) {
            .card-size-lg {
                height: 620px;
            }
        }

        /* Session card header responsive layout */
        .session-card-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            row-gap: 4px;
            height: auto;
            min-height: 3rem;
        }
        .session-card-header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 0;
        }
        .session-card-header-left > div {
            min-width: 0;
        }
        .session-card-header-right {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .session-card-header-right > button {
            padding: 0.2rem 0.25rem;
        }
        
        /* Extra mobile layout tuning to avoid buttons overflowing on very small screens */
        @media (max-width: 640px) {
            /* Keep builder indicator on its own row when visible, but avoid expanding other controls too much */
            #builderActiveIndicator {
                flex: 0 0 100%;
            }

            /* Prevent run button from shrinking too small, keep it visually stable */
            #runBtn {
                flex-shrink: 0;
            }

            /* Bottom multi-select toolbar: keep fully visible and slightly higher on phones */
            #selectionToolbar {
                width: 100%;
                max-width: calc(100% - 1.5rem);
                padding-left: 0.75rem;
                padding-right: 0.75rem;
                overflow-x: auto;
                bottom: 4.5rem;
            }

            #selectionToolbar > div {
                flex-wrap: nowrap;
            }

            #selectionToolbar button {
                white-space: nowrap;
            }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-sm selection:bg-blue-500/30 touch-none" id="appBody">
    <!-- Drag Overlay (Global) -->
    <div id="dragOverlay" class="fixed inset-0 z-[100] hidden flex items-center justify-center">
        <div class="text-blue-400 font-bold text-2xl flex flex-col items-center animate-bounce">
            <span class="material-symbols-rounded text-6xl mb-4">cloud_upload</span>
            拖拽图片以上传
        </div>
    </div>

    <!-- Mobile Sidebar Backdrop -->
    <div id="mobileSidebarBackdrop" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-20 md:hidden hidden transition-opacity" onclick="toggleMobileSidebar(false)"></div>

    <!-- LEFT SIDEBAR: CONFIGURATION (Responsive: Drawer on Mobile, Fixed on Desktop) -->
    <aside id="leftSidebar" class="fixed inset-y-0 left-0 z-30 w-80 bg-[#0f1219] border-r border-gray-800 flex flex-col shadow-2xl flex-shrink-0 transform -translate-x-full md:translate-x-0 md:relative transition-transform duration-300 ease-in-out">
        <div class="h-14 flex items-center px-5 border-b border-gray-800 bg-[#0b0f19] justify-between md:justify-start">
            <div class="flex items-center">
                <span class="material-symbols-rounded text-blue-500 mr-2 text-xl">all_inclusive</span>
                <h1 class="font-bold text-gray-200 tracking-tight text-base">Gemini <span class="hidden lg:inline">工作台</span> <span class="text-[10px] text-gray-500 font-normal border border-gray-700 px-1 rounded ml-2">v4.9 修改版</span></h1>
            </div>
            <button class="md:hidden text-gray-500 hover:text-white" onclick="toggleMobileSidebar(false)">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-5 space-y-6 custom-scrollbar pb-20 md:pb-5">
            <!-- Mobile Theme Toggles -->
            <div class="md:hidden grid grid-cols-2 gap-2">
                <button id="mobileThemeToggleBtn" class="py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 flex items-center justify-center gap-2 transition-colors active:scale-95" onclick="toggleTheme()">
                    <span class="material-symbols-rounded">light_mode</span> 主题
                </button>
                <button id="mobileBwToggleBtn" class="py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 flex items-center justify-center gap-2 transition-colors active:scale-95" onclick="toggleBW()">
                    <span class="material-symbols-rounded">invert_colors</span> 黑白
                </button>
            </div>

            <!-- Connection -->
            <section class="space-y-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">连接设置</h3>
                    <button class="text-[10px] text-blue-400 hover:text-blue-300 border border-blue-900/50 bg-blue-900/10 px-2 py-1 rounded transition-colors flex items-center gap-1" onclick="saveApiConfig()">
                        <span class="material-symbols-rounded text-[14px]">save</span> 保存配置
                    </button>
                </div>
                <div class="space-y-1.5">
                   <label class="text-[10px] text-gray-400 font-medium uppercase">API 格式</label>
                   <div id="apiFormatGroup" class="flex gap-2">
                        <button type="button" data-value="gemini" class="flex-1 py-1.5 rounded-lg border bg-blue-600 border-blue-500 text-white text-xs font-medium transition-colors active:scale-95" aria-pressed="true">Gemini</button>
                        <button type="button" data-value="openai" class="flex-1 py-1.5 rounded-lg border bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800 text-xs font-medium transition-colors active:scale-95" aria-pressed="false">OpenAI</button>
                        <button type="button" data-value="vertex" class="flex-1 py-1.5 rounded-lg border bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800 text-xs font-medium transition-colors active:scale-95" aria-pressed="false">Vertex</button>
                   </div>
                </div>
                <div class="space-y-1.5">
                    <label class="text-[10px] text-gray-400 font-medium uppercase">基础 URL (Base URL)</label>
                    <input autocomplete="off" class="input-dark w-full rounded px-3 py-2 text-xs font-mono" id="baseUrl" type="text" value="https://generativelanguage.googleapis.com"/>
                </div>
                <div class="space-y-1.5">
                    <label class="text-[10px] text-gray-400 font-medium uppercase">API 版本</label>
                    <input class="input-dark w-full rounded px-3 py-2 text-xs font-mono text-yellow-500" id="apiVersion" type="text" value="v1beta"/>
                </div>
                <div class="space-y-1.5">
                    <label class="text-[10px] text-gray-400 font-medium uppercase">API 密钥</label>
                    <div class="relative">
                        <input class="input-dark w-full rounded px-3 py-2 text-xs font-mono pr-8" id="apiKey" placeholder="粘贴密钥..." type="password"/>
                        <button class="absolute right-2 top-2 text-gray-500 hover:text-gray-300" onclick="togglePassword()">
                            <span class="material-symbols-rounded text-sm">visibility_off</span>
                        </button>
                    </div>
                </div>
                <div class="space-y-1.5 hidden" id="vertexKeysContainer">
                    <label class="text-[10px] text-gray-400 font-medium uppercase">Vertex Keys (Key|ProjectID，每行一个)</label>
                    <textarea id="vertexKeysInput" class="input-dark w-full rounded px-3 py-2 text-[10px] font-mono min-h-[60px]" placeholder="AQ...|my-project-id&#10;AQ...|another-project-id"></textarea>
                    <p class="text-[10px] text-gray-500">在启用 Vertex 渠道时，将按照顺序轮询使用这些 Key。</p>
                </div>
            </section>
            
            <!-- Saved API Configs -->
            <section class="space-y-2" id="apiConfigListContainer">
                <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">已存配置</h4>
                <div id="apiConfigList" class="space-y-2">
                    <!-- Saved configs will be rendered here -->
                </div>
            </section>

            <hr class="border-gray-800/50"/>
            
            <!-- Model -->
            <section class="space-y-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">模型</h3>
                    <button class="text-[10px] text-blue-400 hover:text-blue-300 border border-blue-900/50 bg-blue-900/10 px-2 py-1 rounded transition-colors flex items-center gap-1" id="fetchModelsBtn">
                        <span class="material-symbols-rounded text-[14px]">sync</span> 刷新列表
                    </button>
                </div>
                <div class="space-y-1.5">
                    <label class="text-[10px] text-gray-400 font-medium uppercase">模型 ID</label>
                    <input class="input-dark w-full rounded px-3 py-2 text-xs font-mono text-green-400 font-bold" id="modelId" list="modelList" type="text" value="gemini-3-pro-image-preview"/>
                    <datalist id="modelList">
                        <option value="gemini-2.0-flash-thinking-exp-01-21">
                        <option value="gemini-2.0-flash-exp">
                        <option value="gemini-1.5-pro">
                        <option value="gemini-1.5-flash">
                    </datalist>
                </div>
            </section>

            <!-- Config Buttons -->
            <section>
                <button onclick="toggleConfigModal(true)" class="w-full py-3 md:py-2 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg text-xs text-gray-300 flex items-center justify-center gap-2 transition-colors active:scale-95">
                    <span class="material-symbols-rounded text-base text-purple-400">tune</span>
                    高级配置
                </button>
                <div class="mt-2 text-[10px] text-gray-500 text-center">安全设定、思考过程及自定义 Payload</div>
            </section>

            <hr class="border-gray-800/50"/>
            
            <!-- Params -->
            <section class="space-y-5">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">基础参数</h3>
                <div>
                    <div class="flex justify-between text-[10px] mb-2">
                        <span class="text-gray-300">并发数</span>
                        <span class="text-blue-400 font-mono font-bold bg-blue-900/20 px-1.5 rounded" id="concVal">1</span>
                    </div>
                    <input class="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500 touch-pan-x" id="concRange" max="10" min="1" step="1" type="range" value="1"/>
                </div>
                <div>
                    <div class="flex justify-between text-[10px] mb-2">
                        <span class="text-gray-300">温度</span>
                        <span class="text-gray-300 font-mono bg-gray-800 px-1.5 rounded" id="tempVal">1.0</span>
                    </div>
                    <input class="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-gray-400 touch-pan-x" id="tempRange" max="2" min="0" step="0.1" type="range" value="1.0"/>
                </div>
                <div class="space-y-1.5">
                    <label class="text-[10px] text-gray-400 font-medium uppercase">系统提示词 (System Prompt)</label>
                    <textarea id="systemPromptQuick" class="input-dark w-full rounded px-3 py-2 text-xs font-mono min-h-[60px]" placeholder="可选：输入系统提示词，将作为系统指令发送给模型..." spellcheck="false"></textarea>
                </div>
                <div class="space-y-1.5">
                    <label class="text-[10px] text-gray-400 font-medium uppercase">模型预填充 (Model Prefill)</label>
                    <textarea id="modelPrefillQuick" class="input-dark w-full rounded px-3 py-2 text-xs font-mono min-h-[60px]" placeholder="可选：输入模型预填充内容，将作为模型的第一次回复插入会话开头..." spellcheck="false"></textarea>
                </div>
            </section>

            <hr class="border-gray-800/50"/>

            <!-- Release Notes -->
            <section class="space-y-3">
                <div class="flex items-center justify-between">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">更新日志</h3>
                    <span class="text-[10px] text-gray-500 font-mono">v4.9 修改版</span>
                </div>
                <ul class="text-[11px] text-gray-400 space-y-1 list-disc list-inside leading-relaxed">
                    <li>感谢牢墨和gemini-3-pro-preview（是id名不是真哈基米）的修改建议</li>
                    <li>各种小功能添加</li>
                    <li>修复了一些bug</li>
                    <li>现在默认隐藏思维链和文字回答</li>
                </ul>
            </section>
        </div>

        <!-- Live Endpoint Display -->
        <div class="px-4 py-3 bg-[#080b12] border-t border-gray-800/50 hidden md:block">
            <div class="text-[9px] text-gray-500 uppercase font-bold mb-1 tracking-wider">实时端点</div>
            <div class="font-mono text-[10px] leading-relaxed break-all">
                <span class="text-gray-500">POST</span> 
                <span class="text-gray-400" id="epBase">...</span>/<span class="text-yellow-600" id="epVer">...</span>/<span class="text-green-400 font-bold" id="epModel">...</span>:generateContent
            </div>
        </div>

        <!-- Footer Status -->
        <div class="p-3 bg-[#0b0f19] border-t border-gray-800 text-[10px] text-gray-600 font-mono flex justify-between items-center absolute bottom-0 w-full md:relative pb-safe">
            <span class="flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-green-500/50"></span> 
                <span class="hidden md:inline">系统就绪</span>
                <span class="md:hidden">Ready</span>
            </span>
            <span id="clock">00:00</span>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col relative bg-[#0b0f19] bg-[radial-gradient(circle_at_top_right,_rgba(15,23,42,0.8),_transparent_50%)] w-full">
        <!-- Top Toolbar -->
        <header class="min-h-[4rem] py-2 border-b border-gray-800 flex flex-wrap md:flex-nowrap items-center px-3 md:px-6 gap-2 md:gap-4 bg-[#0b0f19]/80 backdrop-blur z-20 sticky top-0">
            
            <!-- Mobile Menu Toggle -->
            <button class="md:hidden h-10 w-10 flex items-center justify-center rounded-lg text-gray-400 hover:text-white hover:bg-gray-800 transition-colors" onclick="toggleMobileSidebar(true)">
                <span class="material-symbols-rounded text-xl">menu</span>
            </button>

            <button id="themeToggleBtn" class="hidden md:flex h-10 w-10 items-center justify-center rounded-lg bg-gray-800/50 hover:bg-gray-700 border border-gray-700 text-gray-400 hover:text-yellow-400 transition-colors active:scale-95" onclick="toggleTheme()" title="切换为白色主题">
                <span class="material-symbols-rounded text-xl">light_mode</span>
            </button>
            <button id="bwToggleBtn" class="hidden md:flex h-10 w-10 items-center justify-center rounded-lg bg-gray-800/50 hover:bg-gray-700 border border-gray-700 text-gray-400 hover:text-yellow-400 transition-colors active:scale-95" onclick="toggleBW()" title="切换为黑白界面">
                <span class="material-symbols-rounded text-xl">invert_colors</span>
            </button>
            
            <!-- Upload -->
            <div class="relative group self-start mt-1.5" id="mainMediaBtnContainer">
                <input accept="image/*" class="hidden" id="fileInput" multiple="" type="file"/>
                <button class="h-10 px-3 md:px-4 rounded-lg bg-gray-800/50 hover:bg-gray-700 text-gray-300 border border-gray-700 hover:border-gray-600 transition-all flex items-center gap-2 text-xs font-medium active:scale-95" onclick="document.getElementById('fileInput').click()">
                    <span class="material-symbols-rounded text-xl text-blue-400">add_photo_alternate</span>
                    <span class="hidden sm:inline">媒体</span>
                    <span class="hidden bg-blue-600 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full" id="imgCount">0</span>
                </button>
            </div>
            <!-- Builder Active Indicator -->
            <div id="builderActiveIndicator" class="hidden self-start mt-2 px-3 py-1.5 bg-purple-900/20 border border-purple-500/30 rounded-lg text-[10px] text-purple-300 items-center gap-2 select-none cursor-help" title="媒体将在构建器中管理">
                <span class="material-symbols-rounded text-sm">layers</span>
                <span class="hidden sm:inline">多轮对话构建器已激活</span>
                <span class="sm:hidden">Builder</span>
            </div>
            
            <!-- Prompt Input Area -->
            <div class="flex-1 relative group flex items-start gap-2 min-w-[150px] order-last md:order-none w-full md:w-auto">
                <div class="relative flex-1 bg-[#111827] border border-gray-700 rounded-xl shadow-inner focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500 transition-all flex flex-col min-h-[42px]">
                    <!-- Icon Left -->
                    <div class="absolute top-2.5 left-3 pointer-events-none text-gray-500 group-focus-within:text-blue-400 transition-colors">
                        <span class="material-symbols-rounded">edit_note</span>
                    </div>
                    
                    <!-- Enhanced Textarea -->
                    <textarea 
                        id="promptInput" 
                        rows="1" 
                        class="w-full bg-transparent text-sm text-gray-200 placeholder-gray-600 py-2.5 pl-10 pr-20 outline-none resize-none custom-scrollbar leading-relaxed max-h-32 overflow-hidden"
                        placeholder="输入提示词..."
                        oninput="autoResize(this)"></textarea>

                    <!-- Actions Right -->
                    <div class="absolute top-1.5 right-1.5 flex items-center gap-1 bg-[#111827]/80 backdrop-blur rounded-lg px-1">
                        <!-- Clear -->
                        <button onclick="clearPrompt()" class="p-1 text-gray-500 hover:text-gray-300 rounded hover:bg-gray-700/50 transition-colors" title="清空提示词">
                            <span class="material-symbols-rounded text-lg">close</span>
                        </button>
                        <!-- Maximize -->
                        <button onclick="togglePromptModal(true)" class="p-1 text-gray-500 hover:text-blue-400 rounded hover:bg-blue-900/20 transition-colors" title="高级提示词构建器">
                            <span class="material-symbols-rounded text-lg">open_in_full</span>
                        </button>
                    </div>
                </div>

                <!-- Preset/Collection Buttons (Hidden on very small screens or stacked?) -> Keep aligned -->
                <div class="flex gap-1 md:gap-2 self-start mt-0.5">
                    <button class="h-10 w-10 flex items-center justify-center rounded-lg bg-gray-800/50 hover:bg-gray-700 border border-gray-700 text-gray-400 hover:text-yellow-400 transition-colors active:scale-95" onclick="savePreset()" title="保存当前提示词">
                        <span class="material-symbols-rounded">bookmark_add</span>
                    </button>
                    <button class="h-10 w-10 flex items-center justify-center rounded-lg bg-gray-800/50 hover:bg-gray-700 border border-gray-700 text-gray-400 hover:text-blue-400 transition-colors active:scale-95" onclick="toggleCollectionsModal(true)" title="保存的对话 & 提示词">
                        <span class="material-symbols-rounded">folder_open</span>
                    </button>
                </div>
            </div>
            
            <!-- Card Size Toggle -->
            <div class="flex items-center self-start mt-0.5 gap-1 text-[10px] text-gray-400">
                <span class="hidden xl:inline">卡片大小</span>
                <div class="flex items-center gap-2">
                    <div id="cardSizeToggle" class="flex rounded-lg bg-gray-800/60 border border-gray-700 overflow-hidden">
                        <button type="button" data-size="sm" class="px-2 md:px-3 py-1 text-[10px] text-gray-400 hover:text-gray-100 hover:bg-gray-700/70">小</button>
                        <button type="button" data-size="md" class="px-2 md:px-3 py-1 text-[10px] text-gray-400 hover:text-gray-100 hover:bg-gray-700/70">中</button>
                        <button type="button" data-size="lg" class="px-2 md:px-3 py-1 text-[10px] text-gray-400 hover:text-gray-100 hover:bg-gray-700/70">大</button>
                    </div>
                    <!-- Density Slider for finer control -->
                    <div class="flex items-center gap-1 ml-1">
                        <span class="hidden 2xl:inline text-gray-500">密度</span>
                        <input
                            id="cardDensityRange"
                            type="range"
                            min="1"
                            max="5"
                            step="1"
                            class="w-20 h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500 touch-pan-x"
                            title="调节一行中卡片的密度"
                        />
                    </div>
                </div>
            </div>

            <!-- Generate Button -->
            <button class="self-start mt-0.5 h-10 px-4 md:px-6 rounded-lg bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white text-xs font-bold tracking-wide shadow-lg shadow-blue-900/20 transition-all active:scale-95 flex items-center gap-2 border border-blue-500/50 flex-shrink-0" id="runBtn" onclick="runBatchGeneration()">
                <span class="material-symbols-rounded text-xl">play_circle</span>
                <span class="hidden sm:inline">生成</span>
            </button>
        </header>

        <!-- Image Preview (Global) -->
        <div class="hidden px-4 md:px-6 py-3 border-b border-gray-800 bg-[#0d1117] flex gap-3 overflow-x-auto custom-scrollbar" id="previewStrip"></div>

        <!-- Canvas Grid -->
        <div class="flex-1 overflow-y-auto p-3 md:p-6 custom-scrollbar relative pb-24 md:pb-24 touch-pan-y" id="canvas">
            <div class="grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-4 md:gap-6 max-w-[2000px] mx-auto" id="gridContainer">
                <!-- Empty State -->
                <div class="col-span-full flex flex-col items-center justify-center h-[50vh] md:h-[60vh] text-gray-600 select-none animate-fade-in px-4 text-center" id="emptyState">
                    <div class="w-16 h-16 md:w-20 md:h-20 rounded-2xl bg-gray-800/30 flex items-center justify-center mb-6 border border-gray-800 shadow-2xl">
                        <span class="material-symbols-rounded text-3xl md:text-4xl text-gray-600">grid_view</span>
                    </div>
                    <h2 class="text-lg md:text-xl font-medium text-gray-400">工作台就绪</h2>
                    <p class="text-xs md:text-sm mt-2 text-gray-600 max-w-xs">拖拽图片、配置模型并开始生成。</p>
                </div>
            </div>
        </div>

        <!-- Multi-Select Toolbar -->
        <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-900/95 backdrop-blur-lg border border-gray-700 rounded-xl shadow-2xl px-4 md:px-6 py-2 md:py-3 flex flex-wrap justify-center items-center gap-4 md:gap-6 z-30 transition-all duration-300 translate-y-32 opacity-0 w-[90%] md:w-auto" id="selectionToolbar">
            <div class="flex items-center gap-3 border-r border-gray-700 pr-4 md:pr-6">
                <span class="text-blue-400 font-bold text-lg" id="selectedCount">0</span>
                <span class="text-xs text-gray-400 uppercase tracking-wider font-medium">已选</span>
                <button class="text-xs text-gray-500 hover:text-gray-300 underline ml-2" onclick="clearSelection()">清空</button>
            </div>
            <div class="flex items-center gap-2">
                <button class="flex flex-col items-center gap-1 px-3 py-1 text-gray-400 hover:text-yellow-400 hover:bg-yellow-900/20 rounded-lg transition-colors active:scale-95" onclick="selectAll()">
                    <span class="material-symbols-rounded">select_all</span>
                    <span class="text-[10px]">全选</span>
                </button>
                <button class="flex flex-col items-center gap-1 px-3 py-1 text-gray-400 hover:text-green-400 hover:bg-green-900/20 rounded-lg transition-colors active:scale-95" onclick="downloadSelectedImages()">
                    <span class="material-symbols-rounded">archive</span>
                    <span class="text-[10px]">ZIP</span>
                </button>
                <button class="flex flex-col items-center gap-1 px-3 py-1 text-gray-400 hover:text-yellow-400 hover:bg-yellow-900/20 rounded-lg transition-colors active:scale-95" onclick="saveSelectedSessions()">
                    <span class="material-symbols-rounded">star</span>
                    <span class="text-[10px]">保存</span>
                </button>
                <button class="flex flex-col items-center gap-1 px-3 py-1 text-gray-400 hover:text-red-400 hover:bg-red-900/20 rounded-lg transition-colors active:scale-95" onclick="deleteSelected()">
                    <span class="material-symbols-rounded">delete</span>
                    <span class="text-[10px]">删除</span>
                </button>
            </div>
        </div>
    </main>

    <!-- RIGHT DRAWER: CHAT MODE (Responsive Width) -->
    <div class="fixed inset-y-0 right-0 w-full md:w-[500px] bg-[#0f1219] border-l border-gray-800 shadow-2xl transform translate-x-full transition-transform duration-300 z-40 flex flex-col" id="chatDrawer">
        <div class="h-14 border-b border-gray-800 flex justify-between items-center px-5 bg-[#111827]">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-purple-900/20 flex items-center justify-center text-purple-400 border border-purple-900/50">
                    <span class="material-symbols-rounded">chat</span>
                </div>
                <div class="overflow-hidden">
                    <h3 class="font-bold text-gray-200 text-sm truncate">会话聊天</h3>
                    <p class="text-[10px] text-gray-500 font-mono truncate" id="chatSessionId">ID: ---</p>
                </div>
            </div>
            <div class="flex gap-1">
                <button class="text-gray-500 hover:text-yellow-400 transition-colors p-2 rounded hover:bg-gray-800 active:scale-95" onclick="saveCurrentSessionToLibrary()" title="保存至库">
                    <span class="material-symbols-rounded">star</span>
                </button>
                <button class="text-gray-500 hover:text-white transition-colors p-2 rounded hover:bg-gray-800 active:scale-95" onclick="toggleChatDrawer(false)">
                    <span class="material-symbols-rounded">close_fullscreen</span>
                </button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-4 md:p-5 space-y-6 custom-scrollbar bg-[#0b0f19]" id="chatHistoryContainer"></div>
        <div class="p-4 border-t border-gray-800 bg-[#111827] pb-safe">
            <div class="relative">
                <textarea class="w-full bg-[#1f2937] border border-gray-700 rounded-xl p-3 pr-12 text-sm text-gray-200 outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 resize-none custom-scrollbar" id="chatInput" placeholder="输入回复..." rows="2"></textarea>
                <div class="absolute right-2 bottom-2 flex gap-2">
                    <button class="p-1.5 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed active:scale-95" id="chatStopBtn" onclick="stopActiveChat()" disabled>
                        <span class="material-symbols-rounded text-lg">stop_circle</span>
                    </button>
                    <button class="p-1.5 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed active:scale-95" id="sendChatBtn" onclick="sendChatMessage()">
                        <span class="material-symbols-rounded text-lg">send</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CONFIGURATION MODAL -->
    <div class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" id="configModal">
        <div class="bg-[#0f1219] w-full md:max-w-3xl max-h-[90vh] md:max-h-[85vh] rounded-xl border border-gray-700 flex flex-col overflow-hidden shadow-2xl animate-bounce-in">
            <div class="h-14 border-b border-gray-800 flex justify-between items-center px-5 bg-[#161b26]">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-rounded text-purple-400">tune</span>
                    <span class="font-bold text-gray-200">高级配置</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="saveAdvancedConfig()" class="text-xs text-green-400 hover:text-green-300 flex items-center gap-1 px-2 py-1 rounded hover:bg-green-900/20 transition-colors active:scale-95">
                        <span class="material-symbols-rounded text-sm">save</span>保存设置
                    </button>
                    <button class="text-gray-500 hover:text-white p-2" onclick="toggleConfigModal(false)"><span class="material-symbols-rounded">close</span></button>
                </div>
            </div>
            
            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- Tabs -->
                <div class="flex border-b border-gray-800 bg-[#111827]">
                    <button class="flex-1 md:flex-none px-6 py-3 text-xs font-medium text-blue-400 border-b-2 border-blue-500 bg-blue-900/10 focus:outline-none" id="tabGuiBtn" onclick="switchConfigTab('gui')">图形界面设置</button>
                    <button class="flex-1 md:flex-none px-6 py-3 text-xs font-medium text-gray-400 hover:text-gray-200 focus:outline-none" id="tabJsonBtn" onclick="switchConfigTab('json')">JSON 载荷</button>
                </div>

                <!-- GUI Content -->
                <div id="configGuiPanel" class="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar space-y-6">
                    <!-- Thinking Config -->
                    <div class="bg-gray-800/30 p-4 rounded-lg border border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-sm font-bold text-gray-200 flex items-center gap-2">
                                <span class="material-symbols-rounded text-yellow-400">psychology</span> 思考配置 (Thinking Config)
                            </h4>
                            <div class="flex items-center gap-2">
                                <label class="text-[10px] text-gray-400 uppercase">启用</label>
                                <input type="checkbox" id="includeThoughtsCheck" class="custom-checkbox" checked>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs text-gray-400">
                                <span>预算 (Tokens)</span>
                                <span class="font-mono text-white" id="thinkingBudgetVal">128</span>
                            </div>
                            <input type="range" id="thinkingBudgetRange" min="0" max="8192" step="128" value="128" class="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-yellow-500 touch-pan-x">
                        </div>
                    </div>

                    <!-- Image Settings -->
                    <div class="bg-gray-800/30 p-4 rounded-lg border border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-sm font-bold text-gray-200 flex items-center gap-2">
                                <span class="material-symbols-rounded text-blue-400">photo_size_select_large</span> 图像参数
                            </h4>
                            <div class="flex items-center gap-2">
                                <label class="text-[10px] text-gray-400 uppercase">启用</label>
                                <input type="checkbox" id="includeImageConfigCheck" class="custom-checkbox" checked>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <div class="text-[10px] text-gray-400 uppercase mb-1">分辨率</div>
                                <div id="imageSizeGroup" class="flex flex-wrap gap-2">
                                    <button type="button" data-value="1K" class="px-3 py-1.5 rounded-lg border bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800 text-xs font-medium transition-colors active:scale-95">1K</button>
                                    <button type="button" data-value="2K" class="px-3 py-1.5 rounded-lg border bg-blue-600 border-blue-500 text-white text-xs font-medium transition-colors active:scale-95" aria-pressed="true">2K</button>
                                    <button type="button" data-value="4K" class="px-3 py-1.5 rounded-lg border bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800 text-xs font-medium transition-colors active:scale-95">4K</button>
                                </div>
                            </div>
                            <div>
                                <div class="text-[10px] text-gray-400 uppercase mb-1">比例</div>
                                <div id="aspectRatioGroup" class="grid grid-cols-3 sm:grid-cols-4 gap-2">
                                    <button type="button" data-value="auto" class="px-3 py-1.5 rounded-lg border bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800 text-xs font-medium transition-colors active:scale-95 flex items-center justify-center">auto</button>
                                    <button type="button" data-value="1:1" class="px-3 py-1.5 rounded-lg border bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800 text-xs font-medium transition-colors active:scale-95 flex items-center"><div class="aspect-ratio-preview"><div style="width: 16px; height: 16px;"></div></div>1:1</button>
                                    <button type="button" data-value="3:4" class="px-3 py-1.5 rounded-lg border bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800 text-xs font-medium transition-colors active:scale-95 flex items-center"><div class="aspect-ratio-preview"><div style="width: 12px; height: 16px;"></div></div>3:4</button>
                                    <button type="button" data-value="4:3" class="px-3 py-1.5 rounded-lg border bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800 text-xs font-medium transition-colors active:scale-95 flex items-center"><div class="aspect-ratio-preview"><div style="width: 16px; height: 12px;"></div></div>4:3</button>
                                    <button type="button" data-value="9:16" class="px-3 py-1.5 rounded-lg border bg-blue-600 border-blue-500 text-white text-xs font-medium transition-colors active:scale-95 flex items-center" aria-pressed="true"><div class="aspect-ratio-preview"><div style="width: 9px; height: 16px;"></div></div>9:16</button>
                                    <button type="button" data-value="16:9" class="px-3 py-1.5 rounded-lg border bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800 text-xs font-medium transition-colors active:scale-95 flex items-center"><div class="aspect-ratio-preview"><div style="width: 16px; height: 9px;"></div></div>16:9</button>
                                    <button type="button" data-value="2:3" class="px-3 py-1.5 rounded-lg border bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800 text-xs font-medium transition-colors active:scale-95 flex items-center"><div class="aspect-ratio-preview"><div style="width: 10.7px; height: 16px;"></div></div>2:3</button>
                                    <button type="button" data-value="3:2" class="px-3 py-1.5 rounded-lg border bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800 text-xs font-medium transition-colors active:scale-95 flex items-center"><div class="aspect-ratio-preview"><div style="width: 16px; height: 10.7px;"></div></div>3:2</button>
                                    <button type="button" data-value="4:5" class="px-3 py-1.5 rounded-lg border bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800 text-xs font-medium transition-colors active:scale-95 flex items-center"><div class="aspect-ratio-preview"><div style="width: 12.8px; height: 16px;"></div></div>4:5</button>
                                    <button type="button" data-value="5:4" class="px-3 py-1.5 rounded-lg border bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800 text-xs font-medium transition-colors active:scale-95 flex items-center"><div class="aspect-ratio-preview"><div style="width: 16px; height: 12.8px;"></div></div>5:4</button>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                                    <span>WebP 质量 (50-100)</span>
                                    <span class="font-mono text-gray-200" id="webpQualityVal">95</span>
                                </div>
                                <input
                                    type="range"
                                    id="webpQualityRange"
                                    min="50"
                                    max="100"
                                    step="1"
                                    value="95"
                                    class="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-yellow-500 touch-pan-x">
                            </div>
                            <div class="pt-1 border-t border-gray-700/60 mt-3 flex items-center justify-between">
                                <div class="mr-3">
                                    <div class="text-[10px] text-gray-400 uppercase mb-0.5">响应模态 (Response Modalities)</div>
                                    <div class="text-[10px] text-gray-500 leading-snug">
                                        使用谷歌原生端点 https://generativelanguage.googleapis.com 时启用<br/>
                                    </div>
                                </div>
                                <label class="flex items-center gap-2">
                                    <span class="text-[11px] text-gray-300">TEXT + IMAGE</span>
                                    <input type="checkbox" id="enableResponseModalitiesCheck" class="custom-checkbox">
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Safety Settings -->
                    <div class="bg-gray-800/30 p-4 rounded-lg border border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-sm font-bold text-gray-200 flex items-center gap-2">
                                <span class="material-symbols-rounded text-red-400">shield</span> 安全设置
                            </h4>
                            <div class="flex items-center gap-2">
                                <label class="text-[10px] text-gray-400 uppercase">启用</label>
                                <input type="checkbox" id="includeSafetySettingsCheck" class="custom-checkbox" checked>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Harassment -->
                            <div class="space-y-1">
                                <label class="text-[10px] text-gray-400 uppercase">骚扰内容 (Harassment)</label>
                                <select id="safeHarassment" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1.5 text-xs text-gray-300 outline-none focus:border-blue-500">
                                    <option value="OFF" selected>OFF</option>
                                    <option value="BLOCK_NONE">BLOCK_NONE</option>
                                    <option value="BLOCK_ONLY_HIGH">BLOCK_ONLY_HIGH</option>
                                    <option value="BLOCK_MEDIUM_AND_ABOVE">BLOCK_MEDIUM</option>
                                    <option value="BLOCK_LOW_AND_ABOVE">BLOCK_LOW</option>
                                </select>
                            </div>
                            <!-- Hate Speech -->
                            <div class="space-y-1">
                                <label class="text-[10px] text-gray-400 uppercase">仇恨言论 (Hate Speech)</label>
                                <select id="safeHate" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1.5 text-xs text-gray-300 outline-none focus:border-blue-500">
                                    <option value="OFF" selected>OFF</option>
                                    <option value="BLOCK_NONE">BLOCK_NONE</option>
                                    <option value="BLOCK_ONLY_HIGH">BLOCK_ONLY_HIGH</option>
                                    <option value="BLOCK_MEDIUM_AND_ABOVE">BLOCK_MEDIUM</option>
                                    <option value="BLOCK_LOW_AND_ABOVE">BLOCK_LOW</option>
                                </select>
                            </div>
                             <!-- Sexually Explicit -->
                             <div class="space-y-1">
                                <label class="text-[10px] text-gray-400 uppercase">色情内容 (Sexually Explicit)</label>
                                <select id="safeSex" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1.5 text-xs text-gray-300 outline-none focus:border-blue-500">
                                    <option value="OFF" selected>OFF</option>
                                    <option value="BLOCK_NONE">BLOCK_NONE</option>
                                    <option value="BLOCK_ONLY_HIGH">BLOCK_ONLY_HIGH</option>
                                    <option value="BLOCK_MEDIUM_AND_ABOVE">BLOCK_MEDIUM</option>
                                    <option value="BLOCK_LOW_AND_ABOVE">BLOCK_LOW</option>
                                </select>
                            </div>
                            <!-- Dangerous -->
                            <div class="space-y-1">
                                <label class="text-[10px] text-gray-400 uppercase">危险内容 (Dangerous Content)</label>
                                <select id="safeDanger" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1.5 text-xs text-gray-300 outline-none focus:border-blue-500">
                                    <option value="OFF" selected>OFF</option>
                                    <option value="BLOCK_NONE">BLOCK_NONE</option>
                                    <option value="BLOCK_ONLY_HIGH">BLOCK_ONLY_HIGH</option>
                                    <option value="BLOCK_MEDIUM_AND_ABOVE">BLOCK_MEDIUM</option>
                                    <option value="BLOCK_LOW_AND_ABOVE">BLOCK_LOW</option>
                                </select>
                            </div>
                            <!-- Civic -->
                            <div class="space-y-1">
                                <label class="text-[10px] text-gray-400 uppercase">公民诚信 (Civic Integrity)</label>
                                <select id="safeCivic" class="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1.5 text-xs text-gray-300 outline-none focus:border-blue-500">
                                    <option value="BLOCK_NONE" selected>BLOCK_NONE</option>
                                    <option value="OFF">OFF</option>
                                    <option value="BLOCK_ONLY_HIGH">BLOCK_ONLY_HIGH</option>
                                    <option value="BLOCK_MEDIUM_AND_ABOVE">BLOCK_MEDIUM</option>
                                    <option value="BLOCK_LOW_AND_ABOVE">BLOCK_LOW</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- JSON Content -->
                <div id="configJsonPanel" class="flex-1 hidden flex-col p-0">
                    <div class="bg-[#111827] px-4 py-2 text-[10px] text-gray-500 border-b border-gray-800">
                        输入要合并到请求体中的自定义 JSON 属性。（例如 topK, stopSequences）
                    </div>
                    <textarea id="customJsonInput" class="flex-1 bg-[#0d1117] p-4 text-xs font-mono text-gray-300 outline-none resize-none" placeholder='{ "generationConfig": { "topK": 40 } }'></textarea>
                </div>
            </div>

             <!-- Preview Footer (Expanded & Improved) -->
             <div class="h-1/3 min-h-[150px] border-t border-gray-800 bg-[#0b0f19] flex flex-col">
                <div class="px-4 py-1.5 text-[10px] font-bold text-gray-400 bg-[#111827] border-b border-gray-800 flex justify-between items-center">
                    <span>实时预览 (已合并)</span>
                    <span class="text-gray-600 font-normal">实际 JSON 载荷</span>
                </div>
                <div class="flex-1 overflow-auto p-0 custom-scrollbar bg-[#0d1117]">
                    <pre class="m-0 p-4 text-xs font-mono leading-relaxed"><code class="language-json" id="configPreview">{}</code></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- COLLECTIONS / PRESETS MODAL -->
    <div class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" id="collectionsModal">
        <div class="bg-[#0f1219] w-full max-w-4xl max-h-[85vh] rounded-xl border border-gray-700 flex flex-col overflow-hidden shadow-2xl animate-bounce-in">
            <div class="h-14 border-b border-gray-800 flex justify-between items-center px-5 bg-[#161b26]">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-rounded text-yellow-400">folder_open</span>
                    <span class="font-bold text-gray-200">库</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="importLibrary()" class="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1 px-2 py-1 rounded hover:bg-blue-900/20 transition-colors active:scale-95">
                        <span class="material-symbols-rounded text-sm">upload</span> <span class="hidden sm:inline">导入</span>
                    </button>
                    <button onclick="exportLibrary()" class="text-xs text-green-400 hover:text-green-300 flex items-center gap-1 px-2 py-1 rounded hover:bg-green-900/20 transition-colors active:scale-95">
                        <span class="material-symbols-rounded text-sm">download</span> <span class="hidden sm:inline">导出</span>
                    </button>
                    <input type="file" id="importLibFile" class="hidden" accept=".json">
                    <div class="w-px h-4 bg-gray-700 mx-1"></div>
                    <button class="text-gray-500 hover:text-white p-1" onclick="toggleCollectionsModal(false)"><span class="material-symbols-rounded">close</span></button>
                </div>
            </div>
            
            <div class="flex border-b border-gray-800 bg-[#111827]">
                <button class="flex-1 md:flex-none px-6 py-3 text-xs font-medium text-blue-400 border-b-2 border-blue-500 bg-blue-900/10 focus:outline-none" id="tabPresetsBtn" onclick="switchLibraryTab('presets')">预设 (提示词)</button>
                <button class="flex-1 md:flex-none px-6 py-3 text-xs font-medium text-gray-400 hover:text-gray-200 focus:outline-none" id="tabChatsBtn" onclick="switchLibraryTab('chats')">已存对话</button>
                <button class="flex-1 md:flex-none px-6 py-3 text-xs font-medium text-gray-400 hover:text-gray-200 focus:outline-none" id="tabCollectionsBtn" onclick="switchLibraryTab('collections')">已保存合集</button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 custom-scrollbar" id="libraryList">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- ADVANCED PROMPT BUILDER MODAL -->
    <div class="fixed inset-0 z-50 hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-2 md:p-6" id="promptModal">
        <div class="bg-[#0f1219] w-full max-w-4xl h-[95vh] md:h-[90vh] rounded-xl border border-gray-700 flex flex-col overflow-hidden shadow-2xl animate-bounce-in ring-1 ring-blue-900/30">
            <div class="h-14 border-b border-gray-800 flex justify-between items-center px-4 md:px-5 bg-[#161b26]">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-rounded text-blue-400 text-xl">playlist_add</span>
                    <div>
                        <h3 class="font-bold text-gray-200 text-base">构建器</h3>
                        <p class="text-[10px] text-gray-500 hidden sm:block">系统指令 & 多轮对话</p>
                    </div>
                </div>
                <button class="text-gray-400 hover:text-white p-2 rounded hover:bg-gray-800 transition-colors" onclick="togglePromptModal(false)">
                    <span class="material-symbols-rounded text-xl">close</span>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-[#0b0f19] custom-scrollbar space-y-6 pb-safe" id="promptBuilderContainer">
                <!-- System Instruction -->
                 <div class="group">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wider bg-gray-800 px-2 py-0.5 rounded">系统指令 (System Instruction)</span>
                    </div>
                    <textarea id="systemInstructionInput" class="w-full bg-[#111827] border border-gray-700 rounded-lg p-3 text-sm text-gray-300 outline-none focus:border-blue-500 transition-colors resize-y font-mono min-h-[80px]" placeholder="定义模型的角色和约束条件..."></textarea>
                 </div>
                 <hr class="border-gray-800/50">
                 <!-- Messages -->
                 <div id="builderMessages" class="space-y-4"></div>
            </div>
            
            <!-- Toolbar -->
            <div class="p-2 border-t border-gray-800 bg-[#0f1219] flex justify-center gap-2">
                 <button onclick="addBuilderMessage('user')" class="flex items-center gap-2 px-3 md:px-4 py-2 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg text-gray-300 text-xs font-medium transition-colors active:scale-95">
                    <span class="material-symbols-rounded text-blue-400">person</span> <span class="hidden sm:inline">添加用户</span><span class="sm:hidden">User</span>
                 </button>
                 <button onclick="addBuilderMessage('model')" class="flex items-center gap-2 px-3 md:px-4 py-2 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg text-gray-300 text-xs font-medium transition-colors active:scale-95">
                    <span class="material-symbols-rounded text-purple-400">smart_toy</span> <span class="hidden sm:inline">添加模型</span><span class="sm:hidden">Model</span>
                 </button>
            </div>

            <!-- Footer -->
            <div class="h-16 border-t border-gray-800 bg-[#111827] flex items-center justify-between px-4 md:px-6 pb-safe">
                <div class="flex gap-3">
                    <button onclick="clearPrompt()" class="px-4 py-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg text-xs font-medium transition-colors active:scale-95">
                        清空所有
                    </button>
                </div>
                <div class="flex items-center gap-3">
                     <button onclick="runFromModal()" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-xs font-bold tracking-wide shadow-lg transition-all flex items-center gap-2 active:scale-95">
                        <span class="material-symbols-rounded text-lg">play_circle</span>
                        运行
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LIGHTBOX MODAL -->
    <div class="fixed inset-0 z-50 hidden bg-black/95 backdrop-blur-md flex items-center justify-center opacity-0 transition-opacity duration-300" id="lightbox" onclick="closeLightbox()">
        <div class="absolute top-4 right-4 flex gap-2 z-10">
            <button class="text-white/70 hover:text-blue-400 p-2 bg-gray-800/80 rounded-full backdrop-blur transition-colors active:scale-95" onclick="event.stopPropagation(); downloadCurrentLightboxImage()">
                <span class="material-symbols-rounded text-2xl">download</span>
            </button>
            <button class="text-white/70 hover:text-red-400 p-2 bg-gray-800/80 rounded-full backdrop-blur transition-colors active:scale-95" onclick="closeLightbox()">
                <span class="material-symbols-rounded text-2xl">close</span>
            </button>
        </div>
        <!-- Lightbox Navigation Arrows -->
        <button id="lightboxPrevBtn" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-blue-400 p-2 bg-gray-800/80 rounded-full backdrop-blur transition-colors active:scale-95 z-10" onclick="event.stopPropagation(); navigateLightbox(-1)" title="上一张">
            <span class="material-symbols-rounded text-3xl">chevron_left</span>
        </button>
        <button id="lightboxNextBtn" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-blue-400 p-2 bg-gray-800/80 rounded-full backdrop-blur transition-colors active:scale-95 z-10" onclick="event.stopPropagation(); navigateLightbox(1)" title="下一张">
            <span class="material-symbols-rounded text-3xl">chevron_right</span>
        </button>
        <img class="max-w-[95vw] max-h-[90vh] object-contain rounded-md shadow-2xl transform scale-95 transition-transform duration-300" id="lightboxImg" onclick="event.stopPropagation()" src=""/>
    </div>

    <!-- RAW DATA MODAL -->
    <div class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" id="rawModal">
        <div class="bg-[#0f1219] w-full max-w-5xl h-[85vh] rounded-xl border border-gray-700 flex flex-col overflow-hidden shadow-2xl">
            <div class="h-12 border-b border-gray-800 flex justify-between items-center px-4 bg-[#161b26]">
                <div class="flex items-center gap-2">
                     <span class="material-symbols-rounded text-blue-400">data_object</span>
                     <span class="font-mono text-xs font-bold text-gray-300">原始数据 (RAW DATA)</span>
                </div>
                <button class="text-gray-500 hover:text-white transition-colors p-2 rounded hover:bg-gray-800" onclick="toggleRawModal(false)"><span class="material-symbols-rounded">close</span></button>
            </div>
            <div class="flex-1 flex flex-col md:flex-row overflow-hidden bg-[#0d1117]">
                <div class="w-full md:w-1/2 border-b md:border-b-0 md:border-r border-gray-800 flex flex-col h-1/2 md:h-auto">
                    <div class="px-3 py-2 border-b border-gray-800 bg-[#161b26]/50 text-xs font-bold text-purple-400 font-mono">请求 (REQUEST)</div>
                    <div class="flex-1 overflow-auto p-0 custom-scrollbar"><pre class="m-0 p-4 text-xs font-mono leading-relaxed"><code class="language-json" id="rawReqCode"></code></pre></div>
                </div>
                <div class="w-full md:w-1/2 flex flex-col h-1/2 md:h-auto">
                    <div class="px-3 py-2 border-b border-gray-800 bg-[#161b26]/50 text-xs font-bold text-green-400 font-mono">响应 (RESPONSE)</div>
                    <div class="flex-1 overflow-auto p-0 custom-scrollbar"><pre class="m-0 p-4 text-xs font-mono leading-relaxed"><code class="language-json" id="rawResCode"></code></pre></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden File Input for Builder Rows -->
    <input type="file" id="builderRowInput" class="hidden" accept="image/*" multiple>

    <script>
        // --- STATE ---
        const state = {
            images: [], // Global attachments (for simple mode)
            sessions: {},
            activeSessionId: null,
            selectedSessions: new Set(),
            presets: JSON.parse(localStorage.getItem('gem_presets_v3.7') || '[]'),
            savedChats: JSON.parse(localStorage.getItem('gem_chats_v3.7') || '[]'),
            collections: JSON.parse(localStorage.getItem('gem_collections_v1.0') || '[]'),
            currentLightboxSrc: null,
            
            // Builder State
            systemInstruction: '',
            promptBuilder: [], // { role, text, images: [] }

            // Quick system prompt & model prefill
            quickSystemInstruction: '',
            modelPrefill: '',

            // Config State
            config: {
                thinkingBudget: 128,
                includeThoughts: true,
                includeImageConfig: true,
                includeSafetySettings: true,
                safety: {
                    HARM_CATEGORY_HARASSMENT: "OFF",
                    HARM_CATEGORY_HATE_SPEECH: "OFF",
                    HARM_CATEGORY_SEXUALLY_EXPLICIT: "OFF",
                    HARM_CATEGORY_DANGEROUS_CONTENT: "OFF",
                    HARM_CATEGORY_CIVIC_INTEGRITY: "BLOCK_NONE"
                },
                imageConfig: { imageSize: "2K", aspectRatio: "auto" },
                webpQuality: 95,
                useResponseModalities: false,
                customJson: ""
            },
            apiFormat: 'gemini', // 'gemini' or 'openai'
            activeBuilderRowIdx: null,
            cardSize: (typeof localStorage !== 'undefined' && localStorage.getItem('gem_card_size')) || 'md',
            cardDensity: (typeof localStorage !== 'undefined' && parseInt(localStorage.getItem('gem_card_density') || '3', 10)) || 3
        };
        
        // --- API Config Management ---
        function saveApiConfig() {
            const url = dom.baseUrl.value.trim();
            const key = dom.apiKey.value.trim();
            const apiFormat = state.apiFormat || 'gemini';

            if (!url || !key) {
                alert('URL和密钥不能为空');
                return;
            }
            const name = prompt('为这个配置输入一个名称:', url);
            if (!name) return;

            let configs = JSON.parse(localStorage.getItem('gem_api_configs') || '[]');
            // 检查是否已存在（按 URL + Key 去重）
            const existingIndex = configs.findIndex(c => c.url === url && c.key === key);
            if (existingIndex > -1) {
                // 更新名称和 API 格式
                configs[existingIndex].name = name;
                configs[existingIndex].apiFormat = apiFormat;
            } else {
                configs.push({ name, url, key, apiFormat });
            }
            
            localStorage.setItem('gem_api_configs', JSON.stringify(configs));
            renderApiConfigs();
        }

        function loadApiConfig(index) {
            let configs = JSON.parse(localStorage.getItem('gem_api_configs') || '[]');
            const cfg = configs[index];
            if (cfg) {
                dom.baseUrl.value = cfg.url;
                dom.apiKey.value = cfg.key || '';
                // 同时更新localStorage中的当前值
                localStorage.setItem('gem_base', dom.baseUrl.value);
                localStorage.setItem('gem_key', dom.apiKey.value);

                // 如果保存了 API 格式，则一并恢复
                if (cfg.apiFormat) {
                    state.apiFormat = cfg.apiFormat;
                    localStorage.setItem('gem_api_format', state.apiFormat);

                    // 与按钮点击逻辑保持一致：不同格式自动应用合适的版本 / 端点
                    if (state.apiFormat === 'openai') {
                        dom.apiVersion.value = 'v1';
                        // 如果当前还是 Gemini 默认地址，则自动切换到 OpenAI 官方地址
                        if (!dom.baseUrl.value || dom.baseUrl.value.includes('generativelanguage.googleapis.com')) {
                            dom.baseUrl.value = 'https://api.openai.com';
                            localStorage.setItem('gem_base', dom.baseUrl.value);
                        }
                    } else if (state.apiFormat === 'vertex') {
                        dom.apiVersion.value = 'v1beta1';
                        if (!dom.baseUrl.value) {
                            dom.baseUrl.value = 'https://aiplatform.googleapis.com';
                            localStorage.setItem('gem_base', dom.baseUrl.value);
                        }
                    } else {
                        dom.apiVersion.value = 'v1beta';
                        // 如果当前是 OpenAI 地址，则自动切回 Gemini 默认地址
                        if (!dom.baseUrl.value || dom.baseUrl.value.includes('api.openai.com')) {
                            dom.baseUrl.value = 'https://generativelanguage.googleapis.com';
                            localStorage.setItem('gem_base', dom.baseUrl.value);
                        }
                    }
                    localStorage.setItem('gem_ver', dom.apiVersion.value);
                    updateApiFormatUI();
                }

                updateLiveEndpoint();
                alert(`配置 "${cfg.name}" 已加载`);
            }
        }

        function deleteApiConfig(index) {
            if (!confirm('确定要删除这个配置吗？')) return;
            let configs = JSON.parse(localStorage.getItem('gem_api_configs') || '[]');
            configs.splice(index, 1);
            localStorage.setItem('gem_api_configs', JSON.stringify(configs));
            renderApiConfigs();
        }

        function renderApiConfigs() {
            const listEl = document.getElementById('apiConfigList');
            const containerEl = document.getElementById('apiConfigListContainer');
            if (!listEl || !containerEl) return;

            const configs = JSON.parse(localStorage.getItem('gem_api_configs') || '[]');
            
            if (configs.length === 0) {
                containerEl.style.display = 'none';
                return;
            }
            
            containerEl.style.display = 'block';
            listEl.innerHTML = '';

            configs.forEach((config, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-800/50 p-2 rounded-lg text-xs';
                item.innerHTML = `
                    <div class="flex-1 overflow-hidden mr-2">
                        <div class="font-bold text-gray-300 truncate">${config.name}</div>
                        <div class="text-gray-500 font-mono text-[10px] truncate">${config.url}</div>
                    </div>
                    <div class="flex items-center gap-1 flex-shrink-0">
                        <button onclick="loadApiConfig(${index})" class="p-1 text-gray-400 hover:text-green-400 rounded hover:bg-green-900/20 transition-colors" title="加载"><span class="material-symbols-rounded text-sm">login</span></button>
                        <button onclick="deleteApiConfig(${index})" class="p-1 text-gray-400 hover:text-red-400 rounded hover:bg-red-900/20 transition-colors" title="删除"><span class="material-symbols-rounded text-sm">delete</span></button>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }

        const dom = {
            // ... existing refs ...
            baseUrl: document.getElementById('baseUrl'),
            apiVersion: document.getElementById('apiVersion'),
            apiKey: document.getElementById('apiKey'),
            modelId: document.getElementById('modelId'),
            vertexKeysContainer: document.getElementById('vertexKeysContainer'),
            vertexKeysInput: document.getElementById('vertexKeysInput'),
            concRange: document.getElementById('concRange'),
            concVal: document.getElementById('concVal'),
            tempRange: document.getElementById('tempRange'),
            tempVal: document.getElementById('tempVal'),
            systemPromptQuick: document.getElementById('systemPromptQuick'),
            modelPrefillQuick: document.getElementById('modelPrefillQuick'),
            
            promptInput: document.getElementById('promptInput'),
            fileInput: document.getElementById('fileInput'),
            previewStrip: document.getElementById('previewStrip'),
            grid: document.getElementById('gridContainer'),
            emptyState: document.getElementById('emptyState'),
            runBtn: document.getElementById('runBtn'),
            imgCount: document.getElementById('imgCount'),
            mainMediaBtnContainer: document.getElementById('mainMediaBtnContainer'),
            builderActiveIndicator: document.getElementById('builderActiveIndicator'),
            
            selectionToolbar: document.getElementById('selectionToolbar'),
            selectedCount: document.getElementById('selectedCount'),
            
            chatDrawer: document.getElementById('chatDrawer'),
            chatHistory: document.getElementById('chatHistoryContainer'),
            chatInput: document.getElementById('chatInput'),
            chatSessionId: document.getElementById('chatSessionId'),
            sendChatBtn: document.getElementById('sendChatBtn'),
            chatStopBtn: document.getElementById('chatStopBtn'),
            leftSidebar: document.getElementById('leftSidebar'),
            mobileSidebarBackdrop: document.getElementById('mobileSidebarBackdrop'),
            lightbox: document.getElementById('lightbox'),
            lightboxImg: document.getElementById('lightboxImg'),

            // New Refs
            configModal: document.getElementById('configModal'),
            configGuiPanel: document.getElementById('configGuiPanel'),
            configJsonPanel: document.getElementById('configJsonPanel'),
            configPreview: document.getElementById('configPreview'),
            customJsonInput: document.getElementById('customJsonInput'),
            tabGuiBtn: document.getElementById('tabGuiBtn'),
            tabJsonBtn: document.getElementById('tabJsonBtn'),

            collectionsModal: document.getElementById('collectionsModal'),
            libraryList: document.getElementById('libraryList'),
            tabPresetsBtn: document.getElementById('tabPresetsBtn'),
            tabChatsBtn: document.getElementById('tabChatsBtn'),
            tabCollectionsBtn: document.getElementById('tabCollectionsBtn'),
            importLibFile: document.getElementById('importLibFile'),

            promptModal: document.getElementById('promptModal'),
            builderMessages: document.getElementById('builderMessages'),
            systemInstructionInput: document.getElementById('systemInstructionInput'),
            builderRowInput: document.getElementById('builderRowInput'),
            promptBuilderContainer: document.getElementById('promptBuilderContainer'),

            dragOverlay: document.getElementById('dragOverlay'),
            clock: document.getElementById('clock'),
            cardSizeToggle: document.getElementById('cardSizeToggle'),
            cardDensityRange: document.getElementById('cardDensityRange'),
            
            // Live Endpoint
            epBase: document.getElementById('epBase'),
            epVer: document.getElementById('epVer'),
            epModel: document.getElementById('epModel'),

            // Raw data modal
            rawModal: document.getElementById('rawModal'),
            rawReqCode: document.getElementById('rawReqCode'),
            rawResCode: document.getElementById('rawResCode')
        };

        const vertexKeyManager = {
            keys: [],
            index: 0,
            parse(raw = '') {
                const list = [];
                raw.split('\n').forEach(line => {
                    const trimmed = line.trim();
                    if (!trimmed) return;
                    const parts = trimmed.split('|');
                    if (parts.length >= 2) {
                        const key = parts[0].trim();
                        const projectId = parts[1].trim();
                        if (key && projectId) {
                            list.push({ key, projectId });
                        }
                    }
                });
                this.keys = list;
                return list.length;
            },
            loadFromStorage() {
                try {
                    const raw = localStorage.getItem('gem_vertex_keys') || '';
                    if (dom.vertexKeysInput) dom.vertexKeysInput.value = raw;
                    this.parse(raw);
                } catch (e) {
                    this.keys = [];
                }
            },
            updateFromTextarea(value) {
                localStorage.setItem('gem_vertex_keys', value);
                this.parse(value);
            },
            getNext() {
                if (!this.keys.length) return null;
                const cred = this.keys[this.index];
                this.index = (this.index + 1) % this.keys.length;
                return cred;
            }
        };

        const BASE64_COMPARE_LENGTH = 100;
        let INLINE_IMAGE_ID_COUNTER = 0;

        const RETRY_BASE_DELAY_MS = 1000;
        const MAX_429_ATTEMPTS = 3;

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function cloneImages(images = []) {
            return (images || []).map(img => ({ ...img }));
        }

        function clonePromptBuilder(builder = []) {
            return (builder || []).map(msg => ({
                role: msg.role,
                text: msg.text || '',
                images: cloneImages(msg.images || [])
            }));
        }

        function normalizeBase64(data = '') {
            if(!data) return '';
            let clean = data
                .replace(/[\s\r\n\t]+/g, '')
                .replace(/-/g, '+')
                .replace(/_/g, '/')
                .replace(/[^A-Za-z0-9+/=]/g, '');
            clean = clean.replace(/=+$/, '');
            const pad = (4 - (clean.length % 4)) % 4;
            return clean + '='.repeat(pad);
        }

        function getInlineData(part = {}) {
            return part.inline_data || part.inlineData || part.inLineData;
        }

        async function convertBase64ToWebP(dataUrl, quality = 0.95) {
            return new Promise((resolve, reject) => {
                try {
                    const img = new Image();
                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.naturalWidth || img.width;
                            canvas.height = img.naturalHeight || img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            const webpDataUrl = canvas.toDataURL('image/webp', quality);
                            const parts = webpDataUrl.split(';base64,');
                            if (parts.length !== 2) {
                                reject(new Error('Unexpected WebP data URL format'));
                                return;
                            }
                            resolve({
                                mime: parts[0].split(':')[1] || 'image/webp',
                                data: parts[1]
                            });
                        } catch (err) {
                            reject(err);
                        }
                    };
                    img.onerror = () => reject(new Error('Failed to decode image for WebP conversion'));
                    img.src = dataUrl;
                } catch (err) {
                    reject(err);
                }
            });
        }

        async function ensureInlineImageWebP(inlineData) {
            if (!inlineData || !inlineData.data) return inlineData;
            const currentMime = inlineData.mime_type || inlineData.mimeType || 'image/png';
            if (currentMime === 'image/webp') {
                return { ...inlineData, mime_type: 'image/webp' };
            }
            try {
                const normalized = normalizeBase64(inlineData.data);
                const dataUrl = `data:${currentMime};base64,${normalized}`;
                const qInt = (typeof state.config?.webpQuality === 'number' && state.config.webpQuality > 0 && state.config.webpQuality <= 100)
                    ? state.config.webpQuality
                    : 95;
                const converted = await convertBase64ToWebP(dataUrl, qInt / 100);
                return {
                    ...inlineData,
                    mime_type: converted.mime,
                    mimeType: converted.mime,
                    data: converted.data
                };
            } catch (err) {
                console.warn('WebP conversion failed, using original image.', err);
                return {
                    ...inlineData,
                    mime_type: currentMime,
                    data: normalizeBase64(inlineData.data)
                };
            }
        }

        async function prepareMessagesForRequest(messages = []) {
            const prepared = [];
            for (const msg of messages || []) {
                const newParts = [];
                const parts = msg.parts || [];
                for (const part of parts) {
                    // 标记了 thought: true 的文本块仅作为“思维链摘要”展示给用户，
                    // 不需要在下一轮继续回传给模型。
                    if (part && part.thought === true) {
                        continue;
                    }
                    if (part && typeof part.text === 'string') {
                        // 仅在 OpenAI 转接时过滤“思维过程”文本；Gemini / Vertex 现在依赖 thought 标记来区分思维链摘要
                        if (
                            state.apiFormat === 'openai' &&
                            (part.text.startsWith(" pensée") || part.text.includes("Tool Code:"))
                        ) {
                            continue;
                        }
                    }
                    const inlineData = getInlineData(part);
                    if (inlineData && inlineData.data && !part.__webpOptimized) {
                        try {
                            const optimized = await ensureInlineImageWebP(inlineData);
                            if (part.inline_data) {
                                part.inline_data = optimized;
                            } else if (part.inlineData) {
                                part.inlineData = optimized;
                            } else if (part.inLineData) {
                                part.inLineData = optimized;
                            }
                            Object.defineProperty(part, '__webpOptimized', {
                                value: true,
                                enumerable: false,
                                configurable: true
                            });
                        } catch (err) {
                            console.warn('Failed to optimize inline image to WebP, fallback to original.', err);
                        }
                    }
                    newParts.push(part);
                }
                // 如果该轮消息全部是 thought:true 的摘要块，则 newParts 为空，直接丢弃整条消息，
                // 避免发送 role/parts 结构但没有任何有效内容。
                if (newParts.length > 0) {
                    prepared.push({
                        role: msg.role,
                        parts: newParts
                    });
                }
            }
            return prepared;
        }

        function getPartImageSource(part = {}) {
            const inlineData = getInlineData(part);
            if(inlineData?.data) {
                const inlineMime = inlineData.mime_type || inlineData.mimeType || 'image/png';
                return `data:${inlineMime};base64,${normalizeBase64(inlineData.data)}`;
            }
            const imageUrl = part.image?.url || part.media?.url || part.media?.imageUri || part.media?.uri;
            const fileData = part.file_data || part.fileData;
            if(fileData?.file_uri) return fileData.file_uri;
            return imageUrl || null;
        }

        function getPartImageKey(part = {}) {
            const inlineData = getInlineData(part);
            if(inlineData?.data) {
                const inlineMime = inlineData.mime_type || inlineData.mimeType || 'image/png';
                const normalized = normalizeBase64(inlineData.data);
                const sample = normalized.slice(0, BASE64_COMPARE_LENGTH);
                return `inline:${inlineMime}:${sample}`;
            }
            const fileData = part.file_data || part.fileData;
            if(fileData?.file_uri) return `file:${fileData.file_uri}`;
            const imageUrl = part.image?.url || part.media?.url || part.media?.imageUri || part.media?.uri;
            if(imageUrl) return `url:${imageUrl.trim()}`;
            return null;
        }

        function getLastImageIndexes(parts = []) {
            const indexes = new Set();
            const seen = new Set();
            for(let i = parts.length - 1; i >= 0; i--) {
                const key = getPartImageKey(parts[i]);
                const src = getPartImageSource(parts[i]);
                if(key && src && !seen.has(key)) {
                    seen.add(key);
                    indexes.add(i);
                }
            }
            return indexes;
        }

        // 为内联图片生成一个稳定且唯一的本地文件名（与 saved 对话 / 合集以及 ZIP 内路径统一）
        function getInlineImageFilename(part) {
            const inlineData = getInlineData(part);
            if (!inlineData || !inlineData.data) return null;

            const inlineMime = inlineData.mime_type || inlineData.mimeType || 'image/png';
            const ext = (inlineMime.split('/')[1] || 'png').toLowerCase();

            // 如果这个 part 之前已经生成过文件名，则复用，避免同一张图片在不同保存路径下名称不一致
            if (part.__inlineFileName && typeof part.__inlineFileName === 'string') {
                return {
                    filename: part.__inlineFileName,
                    mime: inlineMime
                };
            }

            // 使用时间戳 + 递增计数器 + 一小段 base64 指纹，确保在不同对话 / 合集中也不会冲突
            const normalized = normalizeBase64(inlineData.data);
            const shortFingerprint = normalized.slice(0, 16);
            const uniqueId = `${Date.now()}_${INLINE_IMAGE_ID_COUNTER++}`;
            const rawName = `img_${uniqueId}_${shortFingerprint}`;
            const safeKey = rawName.replace(/[^a-zA-Z0-9_\-]+/g, '_');
            const filename = `save image/${safeKey}.${ext}`;

            // 存在非枚举属性上，既能在运行期多次复用，又不会污染保存到 localStorage 的 JSON
            Object.defineProperty(part, '__inlineFileName', {
                value: filename,
                writable: false,
                enumerable: false,
                configurable: true
            });

            return {
                filename,
                mime: inlineMime
            };
        }

                // --- COLLECTION PACK/UNPACK & STORAGE HELPERS (avoid huge localStorage payloads) ---
                function makeMessagesStorageSafe(messages = []) {
                    return (messages || []).map(msg => {
                        const safeParts = [];
                        (msg.parts || []).forEach(part => {
                            const inlineData = getInlineData(part);
                            if (inlineData && inlineData.data) {
                                // 对内联图片：丢弃 Base64，本地只保存一个指向 save image/ 的相对路径
                                const hasText = part.text && String(part.text).trim().length > 0;
                                if (hasText) {
                                    // 文本单独存一份，避免把原来的 part 连同 inline_data 一起塞进 localStorage
                                    safeParts.push({ text: part.text });
                                }
                                const fileInfo = getInlineImageFilename(part);
                                if (fileInfo) {
                                    safeParts.push({
                                        file_data: {
                                            mime_type: fileInfo.mime,
                                            file_uri: fileInfo.filename
                                        }
                                    });
                                } else if (!hasText) {
                                    // 理论上不会走到这里，兜底兼容旧数据
                                    safeParts.push({
                                        text: '[图片已省略，请在原页面或导出的 ZIP 中查看]'
                                    });
                                }
                                // 不拷贝 inline_data
                            } else {
                                // 非内联图片（远程 URL / 已有 file_data 等）原样保留
                                safeParts.push(part);
                            }
                        });
                        return { role: msg.role, parts: safeParts };
                    });
                }
        
                function packCollectionSessions(sessions = []) {
                    const assets = [];
                    const keyToIndex = new Map();
                    const packedSessions = sessions.map(sess => {
                        // 先对消息做轻量化处理，确保不会把大图塞进合集
                        const safeMessages = makeMessagesStorageSafe(sess.messages || []);
                        const packedMessages = safeMessages.map(msg => {
                            const parts = (msg.parts || []).map(part => {
                                const inlineData = getInlineData(part);
                                if (inlineData && inlineData.data) {
                                    // 理论上经过 makeMessagesStorageSafe 这里很少再命中，保留逻辑兼容旧调用
                                    const key = getPartImageKey(part) || `inline:${(inlineData.mime_type || inlineData.mimeType || 'image/png')}:${normalizeBase64(inlineData.data).slice(0, BASE64_COMPARE_LENGTH)}`;
                                    let idx = keyToIndex.get(key);
                                    if (idx == null) {
                                        idx = assets.length;
                                        keyToIndex.set(key, idx);
                                        assets.push({
                                            key,
                                            mime: inlineData.mime_type || inlineData.mimeType || 'image/png',
                                            data: normalizeBase64(inlineData.data)
                                        });
                                    }
                                    return { file_data: { mime_type: inlineData.mime_type || inlineData.mimeType || 'image/png', file_uri: `asset:${idx}` } };
                                }
                                return part;
                            });
                            return { role: msg.role, parts };
                        });
                        return { timestamp: sess.timestamp, systemInstruction: sess.systemInstruction, messages: packedMessages };
                    });
                    return { assets, sessions: packedSessions, v: 1 };
                }

        function unpackCollectionSessions(collection) {
            if (!collection || !Array.isArray(collection.assets)) {
                return collection.sessions || [];
            }
            const assets = collection.assets;
            return (collection.sessions || []).map(sess => {
                const restoredMessages = (sess.messages || []).map(msg => {
                    const parts = (msg.parts || []).map(part => {
                        const fileData = part.file_data || part.fileData;
                        if (fileData && typeof fileData.file_uri === 'string' && fileData.file_uri.startsWith('asset:')) {
                            const idx = parseInt(fileData.file_uri.split(':')[1], 10);
                            const asset = assets[idx];
                            if (asset && asset.data) {
                                return { inline_data: { mime_type: asset.mime || 'image/png', data: asset.data } };
                            }
                        }
                        return part;
                    });
                    return { role: msg.role, parts };
                });
                return { timestamp: sess.timestamp, systemInstruction: sess.systemInstruction, messages: restoredMessages };
            });
        }

        // 一次性轻量化现有库数据，释放 localStorage 空间
        function tryMigrateLibraryToLightweight() {
            const flagKey = 'gem_storage_migrated_v4_light';
            try {
                if (localStorage.getItem(flagKey) === '1') return;

                // savedChats: 只保留文本与非 inline 图片引用
                if (Array.isArray(state.savedChats) && state.savedChats.length) {
                    state.savedChats = state.savedChats.map(chat => ({
                        ...chat,
                        messages: makeMessagesStorageSafe(chat.messages || [])
                    }));
                    localStorage.setItem('gem_chats_v3.7', JSON.stringify(state.savedChats));
                }

                // collections: 会话轻量化，同时丢弃打包的二进制 assets
                if (Array.isArray(state.collections) && state.collections.length) {
                    state.collections = state.collections.map(col => {
                        if (!col || !Array.isArray(col.sessions)) return col;
                        const safeSessions = (col.sessions || []).map(sess => ({
                            ...sess,
                            messages: makeMessagesStorageSafe(sess.messages || [])
                        }));
                        return {
                            ...col,
                            sessions: safeSessions,
                            assets: [] // 不再在本地保存大图数据
                        };
                    });
                    localStorage.setItem('gem_collections_v1.0', JSON.stringify(state.collections));
                }

                localStorage.setItem(flagKey, '1');
            } catch (e) {
                console.warn('轻量化本地库失败，可忽略:', e);
            }
        }

        let activeLibraryTab = 'presets';

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            if(localStorage.getItem('gem_base')) dom.baseUrl.value = localStorage.getItem('gem_base');
            if(localStorage.getItem('gem_ver')) dom.apiVersion.value = localStorage.getItem('gem_ver');
            if(localStorage.getItem('gem_key')) dom.apiKey.value = localStorage.getItem('gem_key');
            if(localStorage.getItem('gem_model')) dom.modelId.value = localStorage.getItem('gem_model');
            state.apiFormat = localStorage.getItem('gem_api_format') || 'gemini';
            state.collections = JSON.parse(localStorage.getItem('gem_collections_v1.0') || '[]'); // 从 localStorage 加载合集

            // 根据当前 apiFormat 自动校正默认 Base URL / 版本，避免 OpenAI 还指向谷歌或反之
            try {
                if (state.apiFormat === 'openai') {
                    if (!dom.baseUrl.value || dom.baseUrl.value.includes('generativelanguage.googleapis.com')) {
                        dom.baseUrl.value = 'https://api.openai.com';
                        localStorage.setItem('gem_base', dom.baseUrl.value);
                    }
                    if (!dom.apiVersion.value) {
                        dom.apiVersion.value = 'v1';
                        localStorage.setItem('gem_ver', dom.apiVersion.value);
                    }
                } else if (state.apiFormat === 'gemini') {
                    if (!dom.baseUrl.value || dom.baseUrl.value.includes('api.openai.com')) {
                        dom.baseUrl.value = 'https://generativelanguage.googleapis.com';
                        localStorage.setItem('gem_base', dom.baseUrl.value);
                    }
                    if (!dom.apiVersion.value) {
                        dom.apiVersion.value = 'v1beta';
                        localStorage.setItem('gem_ver', dom.apiVersion.value);
                    }
                }
            } catch (e) {
                console.warn('初始化时校正 API 配置失败，可忽略:', e);
            }

            // Load quick system prompt & model prefill
            const savedSysPromptQuick = localStorage.getItem('gem_sys_prompt_quick');
            if (savedSysPromptQuick !== null && dom.systemPromptQuick) {
                state.quickSystemInstruction = savedSysPromptQuick;
                dom.systemPromptQuick.value = savedSysPromptQuick;
            }
            const savedModelPrefillQuick = localStorage.getItem('gem_model_prefill_quick');
            if (savedModelPrefillQuick !== null && dom.modelPrefillQuick) {
                state.modelPrefill = savedModelPrefillQuick;
                dom.modelPrefillQuick.value = savedModelPrefillQuick;
            }

            renderApiConfigs(); // Initial render of saved configs
            vertexKeyManager.loadFromStorage();
            updateApiFormatUI();

            // Theme init
            const savedTheme = localStorage.getItem('gem_theme') || 'dark';
            document.documentElement.classList.toggle('dark', savedTheme === 'dark');
            updateThemeToggleIcon();
            // B/W init
            const savedBW = localStorage.getItem('gem_bw') === '1';
            document.documentElement.classList.toggle('bw', savedBW);
            updateBWToggleIcon();
            
            dom.concRange.addEventListener('input', (e) => {
                dom.concVal.textContent = e.target.value;
                updateConfigPreview();
            });
            dom.tempRange.addEventListener('input', (e) => {
                dom.tempVal.textContent = e.target.value;
                updateConfigPreview();
            });
            
            if (dom.systemPromptQuick) {
                dom.systemPromptQuick.addEventListener('input', (e) => {
                    state.quickSystemInstruction = e.target.value;
                    localStorage.setItem('gem_sys_prompt_quick', state.quickSystemInstruction);
                });
            }
            if (dom.modelPrefillQuick) {
                dom.modelPrefillQuick.addEventListener('input', (e) => {
                    state.modelPrefill = e.target.value;
                    localStorage.setItem('gem_model_prefill_quick', state.modelPrefill);
                });
            }
            
            // Inputs
            dom.promptInput.addEventListener('input', () => { autoResize(dom.promptInput); syncInputToBuilder(); });
            dom.promptInput.addEventListener('keydown', handlePromptKeydown);
            dom.chatInput.addEventListener('keydown', (e) => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); }});

            // File Handlers
            dom.fileInput.addEventListener('change', (e) => handleFileUpload(e.target.files, 'global'));
            dom.builderRowInput.addEventListener('change', (e) => handleFileUpload(e.target.files, 'row'));
            dom.importLibFile.addEventListener('change', handleLibraryImport);

            // Drag & Drop
            setupDragDrop();

            // Config Listeners
            setupConfigListeners();

            // Clock & Endpoint Update
            setInterval(() => { dom.clock.textContent = new Date().toLocaleTimeString('en-US', {hour12:false}); }, 1000);
            
            document.getElementById('fetchModelsBtn').addEventListener('click', fetchModels);
            ['baseUrl', 'apiVersion', 'apiKey'].forEach(id => {
                dom[id].addEventListener('input', () => {
                    localStorage.setItem(id==='baseUrl'?'gem_base':id==='apiVersion'?'gem_ver':'gem_key', dom[id].value);
                    updateLiveEndpoint();
                });
            });

            dom.modelId.addEventListener('input', () => {
                localStorage.setItem('gem_model', dom.modelId.value);
                updateLiveEndpoint();
            });

            // 解决当输入框有值时，点击无法显示完整列表的问题
            dom.modelId.onmousedown = () => {
                const currentValue = dom.modelId.value;
                if (currentValue) {
                    dom.modelId.value = "";
                    setTimeout(() => {
                        dom.modelId.value = currentValue;
                    }, 0);
                }
            };

            // Init Config Preview & Endpoint
            loadAdvancedConfig();
            updateConfigPreview();
            updateLiveEndpoint();

            // Card size toggle & initial apply
            if (dom.cardSizeToggle) {
                dom.cardSizeToggle.addEventListener('click', (e) => {
                    const btn = e.target.closest('button[data-size]');
                    if (!btn) return;
                    const size = btn.dataset.size;
                    applyCardSize(size);
                });
            }

            // Density slider (finer control of how many cards per row)
            if (dom.cardDensityRange) {
                dom.cardDensityRange.value = String(state.cardDensity);
                dom.cardDensityRange.addEventListener('input', (e) => {
                    const v = parseInt(e.target.value, 10);
                    applyCardDensity(Number.isFinite(v) ? v : 3);
                });
            }

            applyCardSize(state.cardSize);
            applyCardDensity(state.cardDensity);
            
            // 轻量化已有库，避免之前保存的大图占满 localStorage
            tryMigrateLibraryToLightweight();
            
            // 历史数据轻量化迁移由 tryMigrateLibraryToLightweight 处理；
            // 新的“保存对话 / 保存合集”逻辑在各自函数内部处理体积控制。
        });

        // --- RESPONSIVE UI LOGIC ---
        function toggleMobileSidebar(show) {
            if(show) {
                dom.leftSidebar.classList.remove('-translate-x-full');
                dom.mobileSidebarBackdrop.classList.remove('hidden');
                // Prevent body scroll
                document.body.style.overflow = 'hidden';
            } else {
                dom.leftSidebar.classList.add('-translate-x-full');
                dom.mobileSidebarBackdrop.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        function updateLiveEndpoint() {
            const base = dom.baseUrl.value.replace(/^https?:\/\//, '').replace(/\/$/, '');
            dom.epBase.textContent = base;
            dom.epVer.textContent = dom.apiVersion.value;
            dom.epModel.textContent = dom.modelId.value;
        }

        // --- DRAG & DROP (GLOBAL) ---
        function setupDragDrop() {
            const stop = (e) => { e.preventDefault(); e.stopPropagation(); };

            window.addEventListener('dragenter', (e) => {
                stop(e);
                const hasFiles = Array.from(e.dataTransfer?.types || []).includes('Files');
                if (!hasFiles) return;
                // Only show global overlay if not over a builder row (handled separately)
                if(!e.target.closest('#builderMessages')) dom.dragOverlay.classList.remove('hidden');
            });

            window.addEventListener('dragover', stop);

            window.addEventListener('dragleave', (e) => {
                stop(e);
                // Hide overlay when leaving the page/viewport or the overlay itself
                const outOfWindow = e.clientX <= 0 || e.clientY <= 0 ||
                    e.clientX >= window.innerWidth || e.clientY >= window.innerHeight;

                if (
                    e.target === dom.dragOverlay ||
                    e.target === document ||
                    e.target === document.documentElement ||
                    outOfWindow
                ) {
                    dom.dragOverlay.classList.add('hidden');
                }
            });

            window.addEventListener('drop', (e) => {
                stop(e);
                dom.dragOverlay.classList.add('hidden');
                // If drop on global overlay
                if (e.dataTransfer.files.length > 0) {
                    handleFileUpload(e.dataTransfer.files, 'global');
                }
            });
        }

        function handleFileUpload(files, target, rowIdx = null) {
            Array.from(files).forEach(file => {
                if(!file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const b64 = ev.target.result;
                    const imgObj = { mime: b64.split(';')[0].split(':')[1], data: b64.split(',')[1], b64 };
                    
                    if(target === 'global') {
                        state.images.push(imgObj);
                        renderPreview();
                    } else if(target === 'row') {
                        const idx = rowIdx !== null ? rowIdx : state.activeBuilderRowIdx;
                        if(idx !== null && state.promptBuilder[idx]) {
                            state.promptBuilder[idx].images.push(imgObj);
                            renderBuilder();
                        }
                    }
                };
                reader.readAsDataURL(file);
            });
            // Reset inputs
            dom.fileInput.value = '';
            dom.builderRowInput.value = '';
        }

        // --- CONFIGURATION ---
        function setupConfigListeners() {
            // Vertex key textarea
            if (dom.vertexKeysInput) {
                dom.vertexKeysInput.addEventListener('input', (e) => {
                    vertexKeyManager.updateFromTextarea(e.target.value);
                });
            }

            // Thinking
            document.getElementById('includeThoughtsCheck').addEventListener('change', (e) => {
                state.config.includeThoughts = e.target.checked;
                updateConfigPreview();
            });
            document.getElementById('includeImageConfigCheck').addEventListener('change', (e) => {
                state.config.includeImageConfig = e.target.checked;
                updateConfigPreview();
            });
            document.getElementById('includeSafetySettingsCheck').addEventListener('change', (e) => {
                state.config.includeSafetySettings = e.target.checked;
                updateConfigPreview();
            });
            document.getElementById('thinkingBudgetRange').addEventListener('input', (e) => {
                state.config.thinkingBudget = parseInt(e.target.value);
                document.getElementById('thinkingBudgetVal').textContent = state.config.thinkingBudget;
                updateConfigPreview();
            });
            const respCheck = document.getElementById('enableResponseModalitiesCheck');
            if (respCheck) {
                respCheck.checked = !!state.config.useResponseModalities;
                respCheck.addEventListener('change', (e) => {
                    state.config.useResponseModalities = e.target.checked;
                    updateConfigPreview();
                });
            }

            // Safety
            ['safeHarassment', 'safeHate', 'safeSex', 'safeDanger', 'safeCivic'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    const catMap = {
                        safeHarassment: 'HARM_CATEGORY_HARASSMENT',
                        safeHate: 'HARM_CATEGORY_HATE_SPEECH',
                        safeSex: 'HARM_CATEGORY_SEXUALLY_EXPLICIT',
                        safeDanger: 'HARM_CATEGORY_DANGEROUS_CONTENT',
                        safeCivic: 'HARM_CATEGORY_CIVIC_INTEGRITY',
                    };
                    const key = catMap[id] || id;
                    state.config.safety[key] = e.target.value;
                    updateConfigPreview();
                });
            });

            // JSON
            dom.customJsonInput.addEventListener('input', (e) => {
                state.config.customJson = e.target.value;
                updateConfigPreview();
            });

            // Image config buttons
            setupImageConfigControls();
            
            // WebP quality slider
            const webpRange = document.getElementById('webpQualityRange');
            const webpVal = document.getElementById('webpQualityVal');
            if (webpRange && webpVal) {
                const qInit = typeof state.config.webpQuality === 'number' ? state.config.webpQuality : 95;
                webpRange.value = qInit;
                webpVal.textContent = qInit;
                webpRange.addEventListener('input', (e) => {
                    const v = parseInt(e.target.value, 10);
                    const safe = Number.isFinite(v) ? Math.min(100, Math.max(50, v)) : 95;
                    state.config.webpQuality = safe;
                    webpVal.textContent = safe;
                });
            }
             
            // API Format buttons
           document.getElementById('apiFormatGroup').addEventListener('click', (e) => {
              const btn = e.target.closest('button[data-value]');
              if (!btn) return;
              state.apiFormat = btn.dataset.value;
              localStorage.setItem('gem_api_format', state.apiFormat);
              updateApiFormatUI();
              
              // Auto-update API version for common providers，并在必要时自动切换 Base URL
              if (state.apiFormat === 'openai') {
                  dom.apiVersion.value = 'v1';
                  if (!dom.baseUrl.value || dom.baseUrl.value.includes('generativelanguage.googleapis.com')) {
                      dom.baseUrl.value = 'https://api.openai.com';
                      localStorage.setItem('gem_base', dom.baseUrl.value);
                  }
              } else if (state.apiFormat === 'vertex') {
                  dom.apiVersion.value = 'v1beta1';
                  dom.baseUrl.value = 'https://aiplatform.googleapis.com';
                  localStorage.setItem('gem_base', dom.baseUrl.value);
              } else {
                  dom.apiVersion.value = 'v1beta';
                  if (!dom.baseUrl.value || dom.baseUrl.value.includes('api.openai.com')) {
                      dom.baseUrl.value = 'https://generativelanguage.googleapis.com';
                      localStorage.setItem('gem_base', dom.baseUrl.value);
                  }
              }
              localStorage.setItem('gem_ver', dom.apiVersion.value);
              updateLiveEndpoint();
          });
        }

        function updateConfigPreview() {
            const payload = {};
            const tRaw = parseFloat(dom.tempRange.value);
            const temperature = Number.isFinite(tRaw) ? tRaw : 1.0;
            const generationConfig = {
                temperature,
            };

            if (state.config.includeImageConfig) {
                if (state.config.useResponseModalities) {
                    generationConfig.responseModalities = ["TEXT", "IMAGE"];
                }

                const aspectRatio = state.config.imageConfig?.aspectRatio;
                const imageSize = state.config.imageConfig?.imageSize || state.config.imageConfig?.imagesize || "2K";

                // 构建 imageConfig 时：
                // - 始终发送 imageSize（有默认值 2K）
                // - 仅当比例不是 "auto" 且已设置时才发送 aspectRatio
                //   当为 "auto" 时不带该字段，避免官方端点报错
                const imageConfig = {
                    imageSize
                };
                if (aspectRatio && aspectRatio !== "auto") {
                    imageConfig.aspectRatio = aspectRatio;
                }

                generationConfig.imageConfig = imageConfig;
            }
            if (state.config.includeThoughts) {
                generationConfig.thinkingConfig = {
                    thinkingBudget: state.config.thinkingBudget,
                    includeThoughts: true
                };
            }


            payload.generationConfig = generationConfig;
            // Safety
            if (state.config.includeSafetySettings) {
                const safetySettings = [];
                Object.entries(state.config.safety).forEach(([cat, thresh]) => {
                    if (!thresh || thresh === 'OFF') return;
                    safetySettings.push({ category: cat, threshold: thresh });
                });
                if (safetySettings.length) payload.safetySettings = safetySettings;
            }
            // Custom JSON Merge
            let merged = payload;
            if (state.config.customJson.trim()) {
                try {
                    const custom = JSON.parse(state.config.customJson);
                    merged = {
                        ...payload,
                        ...custom,
                        generationConfig: { ...payload.generationConfig, ...(custom.generationConfig || {}) },
                        safetySettings: custom.safetySettings || payload.safetySettings,
                    };
                } catch (e) {}
            }

            dom.configPreview.textContent = JSON.stringify(merged, null, 2);
            if (window.hljs) hljs.highlightElement(dom.configPreview);
            return merged; // Return for use in generation
        }

        // Image config controls
        function setupImageConfigControls() {
            const sizeGroup = document.getElementById('imageSizeGroup');
            const ratioGroup = document.getElementById('aspectRatioGroup');

            if (sizeGroup) {
                sizeGroup.addEventListener('click', function (e) {
                    const btn = e.target.closest('button[data-value]');
                    if (!btn) return;
                    const val = btn.dataset.value;
                    // 统一使用 imageSize 字段，避免总是落到默认 2K
                    state.config.imageConfig = { ...(state.config.imageConfig || {}), imageSize: val };
                    applyGroupActiveStyles('imageSizeGroup', val);
                    updateConfigPreview();
                });
            }

            if (ratioGroup) {
                ratioGroup.addEventListener('click', function (e) {
                    const btn = e.target.closest('button[data-value]');
                    if (!btn) return;
                    const val = btn.dataset.value;
                    state.config.imageConfig = { ...(state.config.imageConfig || {}), aspectRatio: val };
                    applyGroupActiveStyles('aspectRatioGroup', val);
                    updateConfigPreview();
                });
            }

            // Initialize active styles
            applyGroupActiveStyles('imageSizeGroup', state.config.imageConfig?.imageSize || state.config.imageConfig?.imagesize || '2K');
            applyGroupActiveStyles('aspectRatioGroup', state.config.imageConfig?.aspectRatio || 'auto');
        }

        function applyGroupActiveStyles(groupId, value) {
            const group = document.getElementById(groupId);
            if(!group) return;
            group.querySelectorAll('button[data-value]').forEach(btn => {
                const active = btn.dataset.value === String(value);
                btn.setAttribute('aria-pressed', active ? 'true' : 'false');
                const isAuto = btn.dataset.value === 'auto';
                const baseClasses = 'px-3 py-1.5 rounded-lg border text-xs font-medium transition-colors active:scale-95 flex items-center';
                const justifyClass = isAuto ? 'justify-center' : '';
                
                btn.className = active
                    ? `${baseClasses} ${justifyClass} bg-blue-600 border-blue-500 text-white`
                    : `${baseClasses} ${justifyClass} bg-gray-900 border-gray-700 text-gray-300 hover:bg-gray-800`;
            });
        }

        function updateApiFormatUI() {
            applyGroupActiveStyles('apiFormatGroup', state.apiFormat);
            if (dom.vertexKeysContainer) {
                dom.vertexKeysContainer.classList.toggle('hidden', state.apiFormat !== 'vertex');
            }
        }

        // Save / Load advanced config
        function saveAdvancedConfig() {
            try {
                localStorage.setItem('gem_adv_config_v4.0', JSON.stringify(state.config));
                alert('设置已保存');
            } catch(e) {
                alert('保存失败');
            }
        }

        function loadAdvancedConfig() {
            try {
                const raw = localStorage.getItem('gem_adv_config_v4.0');
                if (!raw) return;
                const cfg = JSON.parse(raw) || {};
                state.config = {
                    ...state.config,
                    ...cfg,
                    safety: { ...state.config.safety, ...(cfg.safety || {}) },
                    imageConfig: {
                        imageSize: '2K',
                        aspectRatio: 'auto',
                        ...(cfg.imageConfig || {})
                    }
                };

                // 兼容旧版本：如果只保存了 imagesize，则同步到 imageSize
                if (
                    state.config.imageConfig &&
                    !state.config.imageConfig.imageSize &&
                    state.config.imageConfig.imagesize
                ) {
                    state.config.imageConfig.imageSize = state.config.imageConfig.imagesize;
                }

                // Apply to UI
                const includeEl = document.getElementById('includeThoughtsCheck');
                const includeImageEl = document.getElementById('includeImageConfigCheck');
                const includeSafetyEl = document.getElementById('includeSafetySettingsCheck');
                const budgetEl = document.getElementById('thinkingBudgetRange');
                const budgetVal = document.getElementById('thinkingBudgetVal');
                if (includeEl) includeEl.checked = state.config.includeThoughts;
                if (includeImageEl) includeImageEl.checked = state.config.includeImageConfig;
                if (includeSafetyEl) includeSafetyEl.checked = state.config.includeSafetySettings;
                if (budgetEl) budgetEl.value = state.config.thinkingBudget;
                if (budgetVal) budgetVal.textContent = state.config.thinkingBudget;

                const webpRange = document.getElementById('webpQualityRange');
                const webpVal = document.getElementById('webpQualityVal');
                if (webpRange && webpVal) {
                    const q = typeof state.config.webpQuality === 'number' ? state.config.webpQuality : 95;
                    webpRange.value = q;
                    webpVal.textContent = q;
                }

                const respCheck = document.getElementById('enableResponseModalitiesCheck');
                if (respCheck) respCheck.checked = !!state.config.useResponseModalities;

                const safetyMap = {
                    safeHarassment: 'HARM_CATEGORY_HARASSMENT',
                    safeHate: 'HARM_CATEGORY_HATE_SPEECH',
                    safeSex: 'HARM_CATEGORY_SEXUALLY_EXPLICIT',
                    safeDanger: 'HARM_CATEGORY_DANGEROUS_CONTENT',
                    safeCivic: 'HARM_CATEGORY_CIVIC_INTEGRITY'
                };
                Object.entries(safetyMap).forEach(([id, cat]) => {
                    const el = document.getElementById(id);
                    if (el && state.config.safety[cat]) el.value = state.config.safety[cat];
                });

                if (typeof state.config.customJson === 'string') {
                    dom.customJsonInput.value = state.config.customJson;
                }

                applyGroupActiveStyles('imageSizeGroup', state.config.imageConfig.imageSize || state.config.imageConfig.imagesize);
                applyGroupActiveStyles('aspectRatioGroup', state.config.imageConfig.aspectRatio);
            } catch (e) {}
        }

        function toggleConfigModal(show) { 
            dom.configModal.classList.toggle('hidden', !show); 
            if (show && window.innerWidth < 768) toggleMobileSidebar(false); // Close sidebar on mobile
        }
        
        function switchConfigTab(tab) {
            if(tab === 'gui') {
                dom.configGuiPanel.classList.remove('hidden');
                dom.configJsonPanel.classList.add('hidden');
                dom.configJsonPanel.classList.remove('flex');
                dom.tabGuiBtn.className = "flex-1 md:flex-none px-6 py-3 text-xs font-medium text-blue-400 border-b-2 border-blue-500 bg-blue-900/10 focus:outline-none";
                dom.tabJsonBtn.className = "flex-1 md:flex-none px-6 py-3 text-xs font-medium text-gray-400 hover:text-gray-200 focus:outline-none";
            } else {
                dom.configGuiPanel.classList.add('hidden');
                dom.configJsonPanel.classList.remove('hidden');
                dom.configJsonPanel.classList.add('flex');
                dom.tabGuiBtn.className = "flex-1 md:flex-none px-6 py-3 text-xs font-medium text-gray-400 hover:text-gray-200 focus:outline-none";
                dom.tabJsonBtn.className = "flex-1 md:flex-none px-6 py-3 text-xs font-medium text-blue-400 border-b-2 border-blue-500 bg-blue-900/10 focus:outline-none";
            }
        }

        // --- BUILDER LOGIC ---
        function syncInputToBuilder() {
            if(state.promptBuilder.length <= 1) {
                const text = dom.promptInput.value;
                if(state.promptBuilder.length === 0 && text) {
                     state.promptBuilder = [{ role: 'user', text, images: [] }];
                } else if(state.promptBuilder.length === 1 && state.promptBuilder[0].role === 'user') {
                    state.promptBuilder[0].text = text;
                }
            }
        }

        function isBuilderWorkflowActive() {
            if(state.promptBuilder.length === 0) return false;
            if(state.promptBuilder.length > 1) return true;
            if(state.systemInstruction.trim().length > 0) return true;
            return state.promptBuilder.some(msg => msg.role !== 'user' || (msg.images && msg.images.length > 0));
        }

        function updateUIForMode() {
            // Check if complex multi-turn
            const isComplex = isBuilderWorkflowActive();
            
            if(isComplex) {
                dom.mainMediaBtnContainer.classList.add('hidden');
                dom.builderActiveIndicator.classList.remove('hidden');
                dom.builderActiveIndicator.classList.add('flex');
                dom.promptInput.placeholder = "多轮对话模式...";
            } else {
                dom.mainMediaBtnContainer.classList.remove('hidden');
                dom.builderActiveIndicator.classList.add('hidden');
                dom.builderActiveIndicator.classList.remove('flex');
                dom.promptInput.placeholder = "输入提示词...";
            }
        }

        function togglePromptModal(show) {
            dom.promptModal.classList.toggle('hidden', !show);
            if(show) {
                const singleUser = state.promptBuilder.length === 1 && state.promptBuilder[0].role === 'user';
                if(state.promptBuilder.length === 0) {
                    state.promptBuilder.push({ role: 'user', text: dom.promptInput.value, images: cloneImages(state.images) });
                } else if(singleUser && (!state.promptBuilder[0].images || state.promptBuilder[0].images.length === 0) && state.images.length) {
                    state.promptBuilder[0].images = cloneImages(state.images);
                    if(!state.promptBuilder[0].text) state.promptBuilder[0].text = dom.promptInput.value;
                }
                dom.systemInstructionInput.value = state.systemInstruction;
                renderBuilder();
            } else {
                state.systemInstruction = dom.systemInstructionInput.value;
                const singleUser = state.promptBuilder.length === 1 && state.promptBuilder[0].role === 'user';
                if(singleUser) {
                    dom.promptInput.value = state.promptBuilder[0].text;
                    if(!state.systemInstruction.trim()) {
                        state.images = cloneImages(state.promptBuilder[0].images || []);
                        state.promptBuilder = [];
                        renderPreview();
                    }
                }
                updateUIForMode();
            }
        }

        function renderBuilder() {
            dom.builderMessages.innerHTML = '';
            state.promptBuilder.forEach((msg, idx) => {
                const isUser = msg.role === 'user';
                const div = document.createElement('div');
                div.className = `group flex gap-3 md:gap-4 animate-fade-in`;
                
                // Thumbnails
                let imgsHtml = '';
                if(msg.images && msg.images.length > 0) {
                    imgsHtml = `<div class="flex gap-2 mt-2 overflow-x-auto pb-1">` +
                        msg.images.map((img, imgIdx) => `
                            <div class="relative w-12 h-12 flex-shrink-0 group/img ${imgIdx===0?'ring-2 ring-yellow-400 rounded':''}">
                                <img src="${img.b64}" class="w-full h-full object-cover rounded border ${imgIdx===0?'border-yellow-500':'border-gray-700'}">
                                <span class="absolute -top-1 -left-1 text-[10px] font-bold bg-black/70 text-white px-1 rounded">${imgIdx + 1}</span>
                                <button onclick="removeBuilderImage(${idx}, ${imgIdx})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 opacity-100 md:opacity-0 md:group-hover/img:opacity-100 transition-opacity" title="移除"><span class="material-symbols-rounded text-[10px]">close</span></button>
                                <button onclick="setFirstBuilderImage(${idx}, ${imgIdx})" class="absolute -bottom-1 left-0 bg-yellow-600 text-white rounded-full p-0.5 opacity-100 md:opacity-0 md:group-hover/img:opacity-100 transition-opacity" title="设为第一"><span class="material-symbols-rounded text-[12px]">looks_one</span></button>
                            </div>
                        `).join('') + `</div>`;
                }

                div.innerHTML = `
                    <div class="w-8 flex flex-col items-center pt-2 gap-1">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center border ${isUser ? 'bg-blue-900/20 border-blue-800 text-blue-400' : 'bg-purple-900/20 border-purple-800 text-purple-400'}">
                            <span class="material-symbols-rounded text-lg">${isUser ? 'person' : 'smart_toy'}</span>
                        </div>
                    </div>
                    <div class="flex-1 bg-[#111827] border border-gray-800 rounded-xl overflow-hidden hover:border-gray-700 transition-colors drop-zone" data-idx="${idx}">
                        <div class="flex items-center justify-between px-3 py-1.5 bg-[#161b26] border-b border-gray-800">
                            <span class="text-[10px] font-bold uppercase tracking-wider ${isUser ? 'text-blue-500' : 'text-purple-500'}">
                                ${isUser ? '用户 (User)' : '模型 (Model)'}
                            </span>
                            <div class="flex items-center gap-1">
                                <button onclick="triggerBuilderUpload(${idx})" class="p-1 hover:bg-gray-700 rounded text-gray-400 hover:text-blue-400" title="Attach Image"><span class="material-symbols-rounded text-base">attachment</span></button>
                                <div class="w-px h-3 bg-gray-700 mx-1"></div>
                                <button onclick="moveBuilderMessage(${idx}, -1)" class="p-1 hover:bg-gray-700 rounded text-gray-500 hover:text-gray-300" ${idx===0?'disabled':''}><span class="material-symbols-rounded text-base">arrow_upward</span></button>
                                <button onclick="moveBuilderMessage(${idx}, 1)" class="p-1 hover:bg-gray-700 rounded text-gray-500 hover:text-gray-300" ${idx===state.promptBuilder.length-1?'disabled':''}><span class="material-symbols-rounded text-base">arrow_downward</span></button>
                                <button onclick="removeBuilderMessage(${idx})" class="p-1 hover:bg-red-900/30 rounded text-gray-500 hover:text-red-400"><span class="material-symbols-rounded text-base">delete</span></button>
                            </div>
                        </div>
                        <div class="p-3">
                            <textarea class="w-full bg-transparent text-sm text-gray-300 outline-none resize-none font-mono leading-relaxed min-h-[60px]" 
                                oninput="updateBuilderMessage(${idx}, this.value)"
                                placeholder="${isUser ? '输入指令...' : '输入响应...'}"
                            >${msg.text}</textarea>
                            ${imgsHtml}
                        </div>
                    </div>
                `;
                
                // Drag & Drop Logic for Row
                const dropZone = div.querySelector('.drop-zone');
                dropZone.addEventListener('dragover', (e) => { 
                    e.preventDefault(); 
                    e.stopPropagation();
                    dropZone.classList.add('builder-drop-active');
                });
                dropZone.addEventListener('dragleave', (e) => { 
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.remove('builder-drop-active');
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.remove('builder-drop-active');
                    if(e.dataTransfer.files.length > 0) handleFileUpload(e.dataTransfer.files, 'row', idx);
                });

                dom.builderMessages.appendChild(div);
                autoResize(div.querySelector('textarea'));
            });
        }

        window.addBuilderMessage = (role) => {
            state.promptBuilder.push({ role, text: '', images: [] });
            renderBuilder();
            dom.promptBuilderContainer.scrollTop = dom.promptBuilderContainer.scrollHeight;
        };
        window.removeBuilderMessage = (idx) => { state.promptBuilder.splice(idx, 1); renderBuilder(); };
        window.moveBuilderMessage = (idx, dir) => {
            const temp = state.promptBuilder[idx];
            state.promptBuilder[idx] = state.promptBuilder[idx+dir];
            state.promptBuilder[idx+dir] = temp;
            renderBuilder();
        };
        window.updateBuilderMessage = (idx, val) => { state.promptBuilder[idx].text = val; };
        window.triggerBuilderUpload = (idx) => {
            state.activeBuilderRowIdx = idx;
            dom.builderRowInput.click();
        };
        window.removeBuilderImage = (msgIdx, imgIdx) => {
            state.promptBuilder[msgIdx].images.splice(imgIdx, 1);
            renderBuilder();
        };

        // Reorder helpers: move selected image to front as "first"
        function moveToFront(arr, idx) {
            if (!Array.isArray(arr) || idx <= 0 || idx >= arr.length) return;
            const [it] = arr.splice(idx, 1);
            arr.unshift(it);
        }
        window.setFirstGlobalImage = (idx) => {
            moveToFront(state.images, idx);
            renderPreview();
        };
        window.setFirstBuilderImage = (msgIdx, imgIdx) => {
            const imgs = state.promptBuilder[msgIdx]?.images;
            if (!imgs) return;
            moveToFront(imgs, imgIdx);
            renderBuilder();
        };
        function clearPrompt() {
            dom.promptInput.value = '';
            dom.systemInstructionInput.value = '';
            state.systemInstruction = '';
            state.promptBuilder = [];
            state.images = [];
            renderBuilder();
            renderPreview();
            updateUIForMode();
            dom.promptInput.focus();
        }
        function runFromModal() {
            state.systemInstruction = dom.systemInstructionInput.value;
            togglePromptModal(false);
            runBatchGeneration();
        }

        // --- CORE GENERATION ---
        async function runBatchGeneration() {
            const key = dom.apiKey.value;
            if (state.apiFormat === 'vertex') {
                if (!vertexKeyManager.keys.length) {
                    alert("需要配置 Vertex Keys（格式：API_KEY|PROJECT_ID，每行一个）");
                    if (dom.vertexKeysContainer) {
                        dom.vertexKeysContainer.classList.remove('hidden');
                    }
                    return;
                }
            } else {
                const trimmed = key.trim();
                if (!trimmed) {
                    alert("需要 API 密钥");
                    return;
                }
            }

            // Construct Contents
            let contents = [];
            let sysInst = null;

            const useBuilder = isBuilderWorkflowActive();
            const quickSysText = (state.quickSystemInstruction || '').trim();
            const modelPrefillText = (state.modelPrefill || '').trim();

            // If using builder state
            if (useBuilder) {
                const builderSys = (state.systemInstruction || '').trim();
                let mergedSys = '';
                if (quickSysText) mergedSys += quickSysText;
                if (builderSys) {
                    if (mergedSys) mergedSys += '\n\n';
                    mergedSys += builderSys;
                }
                sysInst = mergedSys ? { parts: [{ text: mergedSys }] } : null;

                contents = state.promptBuilder.map(msg => {
                    const parts = [];
                    if (msg.text) parts.push({ text: msg.text });
                    msg.images.forEach(img => {
                        parts.push({ inline_data: { mime_type: img.mime, data: img.data } });
                    });
                    return { role: msg.role, parts };
                });
            } else {
                // Simple Mode
                const text = dom.promptInput.value;
                if (!text && state.images.length === 0) return;

                const parts = [];
                if (text) parts.push({ text });
                state.images.forEach(img => {
                    parts.push({ inline_data: { mime_type: img.mime, data: img.data } });
                });
                contents = [{ role: 'user', parts }];

                if (modelPrefillText) {
                    contents.push({
                        role: 'model',
                        parts: [{ text: modelPrefillText }]
                    });
                }

                sysInst = quickSysText ? { parts: [{ text: quickSysText }] } : null;
            }

            dom.emptyState.style.display = 'none';

            const count = parseInt(dom.concRange.value);
            const batchId = Date.now();
            
            // Get merged config
            let requestConfig = updateConfigPreview(); // Helper returns the config object

            // 如果本次请求中提前插入了“模型”消息（例如模型预填充或构建器中的模型轮次），
            // 且启用了思考模式（generationConfig.thinkingConfig），
            // 官方 thinking 接口会要求这些模型文本 part 上带有 thought_signature。
            // 由于这些内容是本地虚构的，我们拿不到合法的 thought_signature，这会触发
            // “Text part is missing a thought_signature ...” 400 错误。
            // 这里检测到这种情况时，仅对本次请求临时关闭 thinkingConfig，避免报错。
            try {
                const hasSyntheticModelText = contents.some(c =>
                    c.role === 'model' &&
                    Array.isArray(c.parts) &&
                    c.parts.some(p => typeof p.text === 'string' && p.text.trim())
                );
                if (
                    hasSyntheticModelText &&
                    requestConfig &&
                    requestConfig.generationConfig &&
                    requestConfig.generationConfig.thinkingConfig
                ) {
                    requestConfig = {
                        ...requestConfig,
                        generationConfig: { ...requestConfig.generationConfig }
                    };
                    delete requestConfig.generationConfig.thinkingConfig;
                }
            } catch (e) {
                console.warn('Prefill/thinking compatibility adjustment failed:', e);
            }

            const promises = [];
            for (let i = 0; i < count; i++) {
                const sessionId = `${batchId}_${i}`;
                state.sessions[sessionId] = {
                    messages: JSON.parse(JSON.stringify(contents)), // Deep copy
                    status: 'busy',
                    timestamp: Date.now(),
                    systemInstruction: sysInst
                };
                const previewText = contents.find(c => c.role === 'user')?.parts.find(p => p.text)?.text || "Image input";
                createCard(sessionId, i + 1, previewText);
                await new Promise(r => setTimeout(r, 50));
                promises.push(executeSessionTurn(sessionId, requestConfig, false));
            }

            await Promise.all(promises);
        }

        async function executeSessionTurn(sessionId, configOverride = null, isRetry = false) {
            const session = state.sessions[sessionId];
            const cardBody = document.getElementById(`body-${sessionId}`);
            const cardStatus = document.getElementById(`status-${sessionId}`);
            if (!session) return;

            session.status = 'busy';

            if (cardStatus) {
                if (isRetry) {
                    cardStatus.className = "mr-2 flex items-center gap-1 text-[10px] text-blue-400 font-mono";
                    cardStatus.innerHTML = `<span class="material-symbols-rounded text-sm">progress_activity</span> 重试中 1/${MAX_429_ATTEMPTS}`;
                } else {
                    cardStatus.className = "mr-2 flex items-center gap-1 text-[10px] text-blue-400 font-mono";
                    cardStatus.innerHTML = `<span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span> 生成中`;
                }
            }

            const base = dom.baseUrl.value.replace(/\/$/, '');
            let lastError = null;
            let wasAborted = false;

            for (let attempt = 1; attempt <= MAX_429_ATTEMPTS; attempt++) {
                try {
                    const controller = new AbortController();
                    session.abortController = controller;
                    let url, headers, body;

                    if (state.apiFormat === 'openai') {
                        // --- OpenAI Payload & Request ---
                        const ver = dom.apiVersion.value.trim();
                        url = `${base}/${ver}/chat/completions`;
                        headers = {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${dom.apiKey.value}`
                        };

                        const oaiMessages = [];
                        if (session.systemInstruction) {
                            oaiMessages.push({ role: 'system', content: session.systemInstruction.parts.map(p => p.text).join('') });
                        }

                        // 在发送给 OpenAI 之前，同样走一遍 prepareMessagesForRequest：
                        //  - 统一对 inline_data 做 WebP 压缩
                        //  - 过滤掉思维链摘要 / Tool Code 文本，只保留正文部分
                        const preparedMessages = await prepareMessagesForRequest(session.messages);

                        preparedMessages.forEach(msg => {
                            const role = msg.role === 'model' ? 'assistant' : 'user';
                            const content = [];
                            (msg.parts || []).forEach(part => {
                                if (part.text) {
                                    content.push({ type: 'text', text: part.text });
                                }

                                // 内联图片（包括 user 上传和 AI 回复里的图片）
                                const inlineData = getInlineData(part);
                                if (inlineData && inlineData.data) {
                                    const mime = inlineData.mime_type || inlineData.mimeType || 'image/png';
                                    const data = normalizeBase64(inlineData.data);
                                    content.push({
                                        type: 'image_url',
                                        image_url: { url: `data:${mime};base64,${data}` }
                                    });
                                }

                                // 远程 / 文件形式图片（file_data）
                                const fileData = part.file_data || part.fileData;
                                if (fileData && fileData.file_uri) {
                                    content.push({
                                        type: 'image_url',
                                        image_url: { url: fileData.file_uri }
                                    });
                                }
                            });
                            oaiMessages.push({ role, content });
                        });
                        
                        const mergedConfig = configOverride || updateConfigPreview();

                        // 根据 baseUrl 判断是否为官方 OpenAI 端点
                        const baseHost = dom.baseUrl.value
                            .trim()
                            .replace(/^https?:\/\//, '')
                            .split('/')[0]
                            .toLowerCase();
                        const isOfficialOpenAI = baseHost === 'api.openai.com';

                        const payload = {
                            model: dom.modelId.value,
                            messages: oaiMessages,
                        };

                        if (isOfficialOpenAI) {
                            // 官方 OpenAI 端点：只使用顶层 temperature
                            payload.temperature = mergedConfig.generationConfig
                                ? mergedConfig.generationConfig.temperature
                                : 1.0;
                        } else {
                            // 非官方端点（自建中转/聚合服务）：附带高级配置
                            // 不设置顶层 temperature，避免与 generationConfig.temperature 重复
                            Object.assign(payload, mergedConfig);
                        }

                        body = JSON.stringify(payload);
                        session.lastRaw = { req: payload };

                    } else if (state.apiFormat === 'vertex') {
                        // --- Vertex (AIPLATFORM) Payload & Request ---
                        const ver = dom.apiVersion.value.trim() || 'v1beta1';
                        const model = dom.modelId.value.trim();
                        const creds = vertexKeyManager.getNext();
                        if (!creds) {
                            throw new Error('Vertex: 未配置 Keys（格式：API_KEY|PROJECT_ID）');
                        }
                        const location = 'us-central1';
                        const publisher = 'google';

                        url = `${base}/${ver}/projects/${creds.projectId}/locations/${location}/publishers/${publisher}/models/${model}:streamGenerateContent?key=${creds.key}`;
                        headers = { 'Content-Type': 'application/json' };

                        const payload = configOverride || updateConfigPreview();
                        payload.contents = await prepareMessagesForRequest(session.messages);
                        if (session.systemInstruction) payload.systemInstruction = session.systemInstruction;

                        // 强制覆盖 Vertex 的安全设置，使用完整的列表以避免报错并绕过审查
                        payload.safetySettings = [
                            { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_CIVIC_INTEGRITY', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_IMAGE_HATE', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_IMAGE_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_IMAGE_HARASSMENT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_IMAGE_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_JAILBREAK', threshold: 'BLOCK_NONE' }
                        ];

                        body = JSON.stringify(payload);
                        session.lastRaw = { req: payload, vertexProjectId: creds.projectId };

                    } else {
                        // --- Gemini Payload & Request ---
                        const ver = dom.apiVersion.value.trim();
                        let model = dom.modelId.value.trim();
                        if (!model.startsWith('models/')) model = `models/${model}`;

                        // 根据 Host 判断是直连官方 Gemini 还是通过代理（如 newapi）
                        const baseHost = dom.baseUrl.value
                            .trim()
                            .replace(/^https?:\/\//, '')
                            .split('/')[0]
                            .toLowerCase();

                        if (baseHost === 'generativelanguage.googleapis.com') {
                            // 官方端点：使用 ?key=AI... 方式鉴权
                            url = `${base}/${ver}/${model}:generateContent?key=${dom.apiKey.value}`;
                            headers = { 'Content-Type': 'application/json' };
                        } else {
                            // 代理 / 网关（例如 newapi）：走 Authorization 头，避免把代理密钥当作 Google key
                            url = `${base}/${ver}/${model}:generateContent`;
                            headers = {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${dom.apiKey.value}`
                            };
                        }

                        const basePayload = configOverride || updateConfigPreview();
                        const preparedContents = await prepareMessagesForRequest(session.messages);
                        const { generationConfig, safetySettings, ...rest } = basePayload || {};

                        // 严格组织顶层字段顺序：contents → tools/自定义字段 → generationConfig → safetySettings → systemInstruction
                        const finalPayload = {
                            contents: preparedContents,
                            ...rest
                        };
                        if (generationConfig) finalPayload.generationConfig = generationConfig;
                        if (safetySettings) finalPayload.safetySettings = safetySettings;
                        if (session.systemInstruction) finalPayload.systemInstruction = session.systemInstruction;

                        body = JSON.stringify(finalPayload);
                        session.lastRaw = { req: finalPayload };
                    }

                    const startTime = performance.now();
                    const res = await fetch(url, { method: 'POST', headers, body, signal: controller.signal });
                    const status = res.status;
                    
                    // 增强的错误处理和响应解析
                    let data;
                    const contentType = res.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            data = await res.json();
                        } catch (e) {
                            throw new Error(`Failed to parse JSON response: ${e.message}`);
                        }
                    } else {
                        const text = await res.text();
                        try {
                            data = JSON.parse(text);
                        } catch (e) {
                            throw new Error(`API returned non-JSON response (${status}): ${text.substring(0, 200)}...`);
                        }
                    }

                    const duration = ((performance.now() - startTime) / 1000).toFixed(1);
                    session.lastRaw.res = data;

                    if (!res.ok) {
                        const errorMsg = data.error?.message || JSON.stringify(data.error) || `API Error ${status}`;
                        if (status === 429 && attempt < MAX_429_ATTEMPTS) {
                            if (cardStatus) {
                                const nextAttempt = attempt + 1;
                                cardStatus.className = "mr-2 flex items-center gap-1 text-[10px] text-yellow-400 font-mono";
                                cardStatus.innerHTML = `<span class="material-symbols-rounded text-sm">schedule</span> 重试中 ${nextAttempt}/${MAX_429_ATTEMPTS}（429，等待重试）`;
                            }
                            const retryAfterHeader = res.headers.get('retry-after');
                            const retryAfter = retryAfterHeader ? parseInt(retryAfterHeader, 10) : NaN;
                            const delayMs = (!Number.isNaN(retryAfter) && retryAfter > 0)
                                ? retryAfter * 1000
                                : RETRY_BASE_DELAY_MS * attempt;
                            await sleep(delayMs);
                            continue;
                        }
                        throw new Error(errorMsg);
                    }

                    let newContent;
                    if (state.apiFormat === 'openai') {
                        const choice = data.choices?.[0];
                        if (choice && choice.message) {
                            const parts = [];
                            const content = choice.message.content;

                            if (Array.isArray(content)) {
                                content.forEach(part => {
                                    if (part.type === 'text') {
                                        parts.push({ text: part.text || '' });
                                    } else if (part.type === 'image_url' && part.image_url && part.image_url.url) {
                                        const url = part.image_url.url;
                                        try {
                                            if (url.startsWith('data:')) {
                                                const [meta, base64Data] = url.split(';base64,');
                                                const mimeMatch = meta && meta.match(/^data:(.*)$/);
                                                const mime = (mimeMatch && mimeMatch[1]) || 'image/png';
                                                parts.push({
                                                    inline_data: {
                                                        mime_type: mime,
                                                        data: base64Data || ''
                                                    }
                                                });
                                            } else {
                                                parts.push({
                                                    file_data: {
                                                        mime_type: 'image/png',
                                                        file_uri: url
                                                    }
                                                });
                                            }
                                        } catch (err) {
                                            console.warn('Failed to parse OpenAI image_url content', err);
                                        }
                                    }
                                });
                            } else if (typeof content === 'string') {
                                const regex = /!\[.*?\]\((.*?)\)/g;
                                let lastIndex = 0;
                                let match;

                                while ((match = regex.exec(content)) !== null) {
                                    if (match.index > lastIndex) {
                                        parts.push({ text: content.substring(lastIndex, match.index) });
                                    }
                                    const imageUrl = match[1];
                                    if (imageUrl.startsWith('data:')) {
                                        const [mime_type, base64_data] = imageUrl.substring(5).split(';base64,');
                                        parts.push({ inline_data: { mime_type, data: base64_data } });
                                    } else {
                                        parts.push({ file_data: { mime_type: 'image/png', file_uri: imageUrl } });
                                    }
                                    lastIndex = regex.lastIndex;
                                }

                                if (lastIndex < content.length) {
                                    parts.push({ text: content.substring(lastIndex) });
                                }
                            }

                            newContent = { role: 'model', parts };
                        }
                    } else {
                        // 兼容 Vertex streamGenerateContent 返回的数组结构
                        // 或者是 Gemini generateContent 返回的对象结构
                        const chunks = Array.isArray(data) ? data : [data];
                        const parts = [];
                        
                        for (const chunk of chunks) {
                            const candidate = chunk.candidates?.[0];
                            if (candidate && candidate.content && candidate.content.parts) {
                                parts.push(...candidate.content.parts);
                            }
                        }
                        
                        if (parts.length > 0) {
                            newContent = { role: 'model', parts };
                        }
                    }

                    if (newContent) {
                        session.messages.push(newContent);
                        if (state.activeSessionId === sessionId) {
                            renderChatMessage('model', newContent.parts);
                        }
                        renderCardPreview(sessionId);
                        if (cardStatus) {
                            cardStatus.className = "mr-2 flex items-center gap-1 text-[10px] text-green-400 font-mono";
                            const attemptInfo = attempt > 1 ? ` · 重试${attempt}次` : "";
                            cardStatus.innerHTML = `<span class="material-symbols-rounded text-sm">check_circle</span> ${duration}s${attemptInfo}`;
                        }
                        disableStopButton(sessionId);
                        session.status = 'idle';
                        session.abortController = null;
                        return;
                    } else {
                        throw new Error(state.apiFormat === 'openai' ? "No valid choice in response" : "No content in response");
                    }
                } catch (e) {
                    if (e.name === 'AbortError') {
                        wasAborted = true;
                        break;
                    }
                    lastError = e;
                    break;
                }
            }

            if (wasAborted) {
                session.abortController = null;
                session.status = 'idle';
                return;
            }

            if (cardBody) {
                cardBody.innerHTML = `<div class="p-3 bg-red-900/20 border border-red-800 rounded text-red-200 text-xs font-mono">${lastError && lastError.message ? lastError.message : '请求失败'}</div>`;
            }
            if (cardStatus) {
                cardStatus.className = "mr-2 flex items-center gap-1 text-[10px] text-red-400 font-mono";
                cardStatus.innerHTML = `<span class="material-symbols-rounded text-sm">error</span> 错误`;
            }
            disableStopButton(sessionId);
            session.status = 'idle';
            session.abortController = null;
        }

        async function retrySession(id) {
            const session = state.sessions[id];
            if (!session) return;
            const bodyEl = document.getElementById(`body-${id}`);
            const statusEl = document.getElementById(`status-${id}`);
            if (bodyEl) {
                bodyEl.innerHTML = `<div class="p-3 bg-blue-900/20 border border-blue-800 rounded text-blue-200 text-xs font-mono">重试中 1/${MAX_429_ATTEMPTS}...</div>`;
            }
            if (statusEl) {
                statusEl.className = "mr-2 flex items-center gap-1 text-[10px] text-blue-400 font-mono";
                statusEl.innerHTML = `<span class="material-symbols-rounded text-sm">progress_activity</span> 重试中 1/${MAX_429_ATTEMPTS}`;
            }
            await executeSessionTurn(id, null, true);
        }

        // --- UI COMPONENTS ---
        function createCard(id, index, prompt) {
            const card = document.createElement('div');
            const isBusy = state.sessions[id]?.status === 'busy';
            const stopBtnDisabledAttr = isBusy ? '' : 'disabled';
            const stopBtnExtraClasses = isBusy ? '' : ' opacity-40 cursor-not-allowed';
            const sizeClass = state.cardSize === 'sm'
                ? 'card-size-sm'
                : state.cardSize === 'lg'
                    ? 'card-size-lg'
                    : 'card-size-md';
            card.className = `glass-panel rounded-xl flex flex-col relative shadow-xl animate-slide-in group border-gray-800 transition-all duration-200 ${sizeClass}`;
            card.id = `card-${id}`;
            card.innerHTML = `
                <div class="session-card-header bg-gray-900/80 border-b border-gray-800 px-3 rounded-t-xl relative z-10">
                    <div class="session-card-header-left flex items-center gap-3">
                        <input type="checkbox" class="custom-checkbox" onchange="toggleSelection('${id}', this.checked)">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span class="text-[10px] font-bold text-gray-500 bg-gray-800 px-2 py-0.5 rounded">#${index}</span>
                            <span class="text-xs text-gray-300 truncate font-medium max-w-[80px] md:max-w-[120px]" title="${prompt}">${prompt.substring(0,30)}...</span>
                        </div>
                    </div>
                    <div class="session-card-header-right flex items-center gap-1">
                        <div id="status-${id}" class="mr-2 flex items-center gap-1 text-[10px] text-blue-400 font-mono"><span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span> 生成中</div>
                        <button onclick="openChat('${id}')" class="p-1.5 text-gray-400 hover:text-purple-400 hover:bg-purple-900/20 rounded transition-colors active:scale-95"><span class="material-symbols-rounded text-lg">chat</span></button>
                        <button onclick="viewRaw('${id}')" class="p-1.5 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors active:scale-95"><span class="material-symbols-rounded text-lg">data_object</span></button>
                        <button id="stop-${id}" onclick="stopSession('${id}')" ${stopBtnDisabledAttr} class="p-1.5 text-gray-400 hover:text-red-400 hover:bg-red-900/20 rounded transition-colors active:scale-95${stopBtnExtraClasses}" title="停止生成"><span class="material-symbols-rounded text-lg">stop_circle</span></button>
                        <button onclick="retrySession('${id}')" class="p-1.5 text-gray-400 hover:text-orange-400 hover:bg-orange-900/20 rounded transition-colors active:scale-95" title="重试此对话"><span class="material-symbols-rounded text-lg">refresh</span></button>
                        <button onclick="deleteSession('${id}')" class="p-1.5 text-gray-400 hover:text-red-400 hover:bg-red-900/20 rounded transition-colors active:scale-95"><span class="material-symbols-rounded text-lg">delete</span></button>
                    </div>
                </div>
                <div id="body-${id}" class="flex-1 overflow-y-auto p-4 md:p-5 prose prose-invert prose-sm max-w-none text-gray-300 custom-scrollbar">
                     <div class="space-y-4 opacity-30 animate-pulse"><div class="h-2 bg-gray-500 rounded w-3/4"></div><div class="h-2 bg-gray-500 rounded w-1/2"></div></div>
                </div>
                <div id="overlay-${id}" class="absolute inset-0 bg-blue-500/10 border-2 border-blue-500 rounded-xl pointer-events-none opacity-0 transition-opacity z-0"></div>
            `;
            dom.grid.prepend(card);
            updateGridLayout();
        }
        
        function applyCardSize(size) {
            if (!['sm', 'md', 'lg'].includes(size)) size = 'md';
            state.cardSize = size;
            try {
                localStorage.setItem('gem_card_size', size);
            } catch (e) {}
            const cards = document.querySelectorAll('#gridContainer > .glass-panel');
            cards.forEach(card => {
                card.classList.remove('card-size-sm', 'card-size-md', 'card-size-lg');
                card.classList.add(
                    size === 'sm' ? 'card-size-sm' :
                    size === 'lg' ? 'card-size-lg' :
                    'card-size-md'
                );
            });
            updateGridLayout();
            updateCardSizeToggleUI();
        }

        // 更细颗粒度控制：通过滑块调节一行中卡片的密度（列数）
        function applyCardDensity(level) {
            let density = parseInt(level, 10);
            if (!Number.isFinite(density) || density < 1 || density > 5) density = 3;
            state.cardDensity = density;
            try {
                localStorage.setItem('gem_card_density', String(density));
            } catch (e) {}
            if (dom.cardDensityRange && dom.cardDensityRange.value !== String(density)) {
                dom.cardDensityRange.value = String(density);
            }
            updateGridLayout();
        }
        
        function updateGridLayout() {
            const gridEl = dom.grid;
            if (!gridEl) return;
            const d = state.cardDensity || 3;
            // 根据密度级别设置列数：1(最稀) - 5(最密)
            let className;
            switch (d) {
                case 1:
                    // 更大卡片，列数少
                    className = "grid grid-cols-1 gap-5 md:gap-6 max-w-[1400px] mx-auto";
                    break;
                case 2:
                    className = "grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-5 max-w-[1600px] mx-auto";
                    break;
                case 3:
                    className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-5 max-w-[2000px] mx-auto";
                    break;
                case 4:
                    className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 md:gap-4 max-w-[2200px] mx-auto";
                    break;
                case 5:
                default:
                    // 最紧凑：尽量多列
                    className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-3 md:gap-4 max-w-[2400px] mx-auto";
                    break;
            }
            gridEl.className = className;
        }
        
        function updateCardSizeToggleUI() {
            const wrap = dom.cardSizeToggle;
            if (!wrap) return;
            const size = state.cardSize;
            wrap.querySelectorAll('button[data-size]').forEach(btn => {
                const active = btn.dataset.size === size;
                btn.className = active
                    ? "px-2 md:px-3 py-1 bg-blue-600 text-white text-[10px] font-medium"
                    : "px-2 md:px-3 py-1 text-[10px] text-gray-400 hover:text-gray-100 hover:bg-gray-700/70";
            });
        }

        // --- LIBRARY (CHATS & PRESETS) ---
        function toggleCollectionsModal(show) {
            dom.collectionsModal.classList.toggle('hidden', !show);
            if(show) renderLibrary();
        }
        function switchLibraryTab(tab) {
            activeLibraryTab = tab;
            ['presets', 'chats', 'collections'].forEach(t => {
                const btn = dom[`tab${t.charAt(0).toUpperCase() + t.slice(1)}Btn`];
                if (btn) {
                    btn.className = tab === t
                        ? "flex-1 md:flex-none px-6 py-3 text-xs font-medium text-blue-400 border-b-2 border-blue-500 bg-blue-900/10 focus:outline-none"
                        : "flex-1 md:flex-none px-6 py-3 text-xs font-medium text-gray-400 hover:text-gray-200 focus:outline-none";
                }
            });
            renderLibrary();
        }
        function renderLibrary() {
            dom.libraryList.innerHTML = '';
            const items = activeLibraryTab === 'presets' ? state.presets : (activeLibraryTab === 'chats' ? state.savedChats : state.collections);
            
            if(items.length === 0) {
                dom.libraryList.innerHTML = '<div class="text-center text-gray-500 py-10">没有找到项目。</div>';
                return;
            }

            items.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-3 hover:bg-gray-800/50 rounded-lg border border-transparent hover:border-gray-700 transition-all group mb-2";
                
                const icon = activeLibraryTab === 'presets' ? 'bookmark' : (activeLibraryTab === 'chats' ? 'chat' : 'collections_bookmark');
                let info;
                if (activeLibraryTab === 'presets') {
                    info = `${item.promptBuilder?.length || 0} 轮 • ${new Date(item.id).toLocaleDateString()}`;
                } else if (activeLibraryTab === 'chats') {
                    info = `${item.messages.length} 条消息 • ${new Date(item.timestamp).toLocaleDateString()}`;
                } else { // collections
                    info = `${item.sessions?.length || 0} 个对话 • ${new Date(item.id).toLocaleDateString()}`;
                }

                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 bg-blue-900/20 rounded-md flex items-center justify-center text-blue-400 border border-blue-900/30">
                            <span class="material-symbols-rounded">${icon}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-bold text-gray-200 truncate">${item.name}</h4>
                            <p class="text-[10px] text-gray-500 truncate">${info}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="loadLibraryItem(${idx})" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-xs rounded shadow-lg font-medium active:scale-95">加载</button>
                        <button onclick="deleteLibraryItem(${idx})" class="p-1.5 text-gray-500 hover:text-red-400 hover:bg-red-900/20 rounded transition-colors active:scale-95"><span class="material-symbols-rounded text-lg">delete</span></button>
                    </div>
                `;
                dom.libraryList.appendChild(div);
            });
        }

        function savePreset() {
            const name = prompt("预设名称:");
            if(!name) return;
            
            // 轻量化图片数据，避免 localStorage 配额超限
            // 只保留必要的元信息，去掉完整的 base64 数据
            function makeImagesLightweight(images = []) {
                return (images || []).map(img => {
                    // 保留 mime 类型和一个短指纹用于标识，但去掉完整的 base64 数据
                    const shortFingerprint = (img.data || '').slice(0, 32);
                    return {
                        mime: img.mime || 'image/png',
                        // 保存一个占位标记，加载时提示用户图片已省略
                        _placeholder: true,
                        _fingerprint: shortFingerprint
                    };
                });
            }
            
            function makePromptBuilderLightweight(builder = []) {
                return (builder || []).map(msg => ({
                    role: msg.role,
                    text: msg.text || '',
                    images: makeImagesLightweight(msg.images || [])
                }));
            }
            
            const preset = {
                id: Date.now(),
                name,
                promptBuilder: makePromptBuilderLightweight(state.promptBuilder),
                systemInstruction: state.systemInstruction,
                images: makeImagesLightweight(state.images),
                // 标记这是轻量化保存的预设
                _lightweight: true
            };
            if(state.promptBuilder.length === 0 && dom.promptInput.value) {
                preset.promptBuilder = [{role:'user', text: dom.promptInput.value, images: makeImagesLightweight(state.images)}];
            }
            
            // 添加错误处理，防止 localStorage 配额超限导致静默失败
            try {
                state.presets.unshift(preset);
                localStorage.setItem('gem_presets_v3.7', JSON.stringify(state.presets));
                
                // 提示用户图片不会被保存
                const hasImages = state.images.length > 0 ||
                    state.promptBuilder.some(msg => msg.images && msg.images.length > 0);
                if (hasImages) {
                    alert("预设已保存！\n\n注意：由于存储限制，预设中的图片不会被保存。加载预设后需要重新添加图片。");
                } else {
                    alert("预设已保存！");
                }
            } catch (e) {
                console.error('保存预设失败:', e);
                // 回滚内存中的插入
                state.presets.shift();
                alert('保存预设失败：本地存储空间可能不足。\n\n请尝试：\n1. 删除一些旧的预设\n2. 使用"库→导出"备份后清理');
            }
        }

        function saveCurrentSessionToLibrary() {
            if (!state.activeSessionId) return;
            const session = state.sessions[state.activeSessionId];
            const name = prompt("保存对话为:", "对话 " + new Date().toLocaleTimeString());
            if (!name) return;

            // 对话保存仍做轻量化处理：去掉内联大图，只保留文本和外链
            const safeMessages = makeMessagesStorageSafe(session.messages || []);

            const chatItem = {
                id: Date.now(),
                timestamp: Date.now(),
                name,
                messages: safeMessages,
                systemInstruction: session.systemInstruction
            };

            try {
                state.savedChats.unshift(chatItem);
                localStorage.setItem('gem_chats_v3.7', JSON.stringify(state.savedChats));
                alert("对话已保存至库!");
            } catch (e) {
                console.error('保存对话失败', e);
                // 回滚内存插入，防止内存状态与磁盘不一致
                state.savedChats.shift();
                alert('保存对话失败：本地存储空间可能不足，请导出或清理旧记录后重试。');
            }

            // 自动导出当前对话相关图片为 ZIP（包含 save image 文件夹）
            const safeBaseName = (name || '').replace(/[\\/:*?"<>|]+/g, '_').trim() || `chat_${chatItem.id}`;
            exportImagesForSessions([state.activeSessionId], `chat_${safeBaseName}`).catch(err => console.error('导出对话图片失败', err));
        }

        function loadLibraryItem(idx) {
            if (activeLibraryTab === 'presets') {
                const p = state.presets[idx];
                
                // 过滤掉轻量化保存时产生的占位图片（没有实际数据）
                function filterPlaceholderImages(images = []) {
                    return (images || []).filter(img => !img._placeholder && img.data && img.b64);
                }
                
                function filterPromptBuilderImages(builder = []) {
                    return (builder || []).map(msg => ({
                        role: msg.role,
                        text: msg.text || '',
                        images: filterPlaceholderImages(msg.images || [])
                    }));
                }
                
                state.promptBuilder = filterPromptBuilderImages(p.promptBuilder || []);
                state.systemInstruction = p.systemInstruction || '';
                state.images = filterPlaceholderImages(p.images || []);
                
                // 检查原预设是否包含被过滤掉的图片
                const hadPlaceholderImages = p._lightweight ||
                    (p.images || []).some(img => img._placeholder) ||
                    (p.promptBuilder || []).some(msg => (msg.images || []).some(img => img._placeholder));
                
                renderPreview();
                toggleCollectionsModal(false);
                togglePromptModal(true);
                
                // 如果预设中有被省略的图片，提示用户
                if (hadPlaceholderImages) {
                    setTimeout(() => {
                        alert("预设已加载！\n\n注意：此预设中的图片在保存时被省略了，请重新添加所需的图片。");
                    }, 100);
                }
            } else if (activeLibraryTab === 'chats') {
                const c = state.savedChats[idx];
                const newId = `restored_${Date.now()}`;
                state.sessions[newId] = {
                    messages: JSON.parse(JSON.stringify(c.messages)),
                    status: 'idle',
                    timestamp: Date.now(),
                    systemInstruction: c.systemInstruction
                };
                toggleCollectionsModal(false);
                createCard(newId, 0, `已恢复: ${c.name}`);
                renderCardPreview(newId);
                document.getElementById(`status-${newId}`).innerHTML = `<span class="text-gray-500">已恢复</span>`;
            } else { // collections
                const collection = state.collections[idx];
                if (!collection || !collection.sessions) return;
                toggleCollectionsModal(false);

                // 如果包含资源包，先解包以恢复 inline_data
                const restoredSessions = Array.isArray(collection.assets)
                    ? unpackCollectionSessions(collection)
                    : collection.sessions;

                restoredSessions.forEach((sessionData, i) => {
                    const newId = `restored_${Date.now()}_${i}`;
                    state.sessions[newId] = {
                        messages: JSON.parse(JSON.stringify(sessionData.messages)),
                        status: 'idle',
                        timestamp: sessionData.timestamp,
                        systemInstruction: sessionData.systemInstruction
                    };
                    createCard(newId, i + 1, `合集: ${collection.name} #${i + 1}`);
                    renderCardPreview(newId);
                    document.getElementById(`status-${newId}`).innerHTML = `<span class="text-gray-500">已恢复</span>`;
                });
            }
        }

        function deleteLibraryItem(idx) {
            if(!confirm("确认删除项目?")) return;
            if (activeLibraryTab === 'presets') {
                state.presets.splice(idx, 1);
                localStorage.setItem('gem_presets_v3.7', JSON.stringify(state.presets));
            } else if (activeLibraryTab === 'chats') {
                state.savedChats.splice(idx, 1);
                localStorage.setItem('gem_chats_v3.7', JSON.stringify(state.savedChats));
            } else { // collections
                state.collections.splice(idx, 1);
                localStorage.setItem('gem_collections_v1.0', JSON.stringify(state.collections));
            }
            renderLibrary();
        }

        function exportLibrary() {
            const data = { version: "4.0", presets: state.presets, chats: state.savedChats, collections: state.collections };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `gemini_library_${Date.now()}.json`;
            a.click();
        }

        function importLibrary() { dom.importLibFile.click(); }
        function handleLibraryImport(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const json = JSON.parse(ev.target.result);
                    if(json.presets) state.presets = [...json.presets, ...state.presets];
                    if(json.chats) state.savedChats = [...json.chats, ...state.savedChats];
                    if(json.collections) state.collections = [...json.collections, ...state.collections];
                    localStorage.setItem('gem_presets_v3.7', JSON.stringify(state.presets));
                    localStorage.setItem('gem_chats_v3.7', JSON.stringify(state.savedChats));
                    localStorage.setItem('gem_collections_v1.0', JSON.stringify(state.collections));
                    renderLibrary();
                    alert("导入成功!");
                } catch(e) { alert("无效的 JSON"); }
            };
            reader.readAsText(file);
        }

        // --- HELPER FUNCTIONS (Existing Logic) ---
        function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
        function handlePromptKeydown(e) { if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); runBatchGeneration(); } }
        function togglePassword() { dom.apiKey.type = dom.apiKey.type === 'password' ? 'text' : 'password'; }

        // Theme toggle
        function updateThemeToggleIcon() {
            const isDark = document.documentElement.classList.contains('dark');
            
            // Desktop
            const btn = document.getElementById('themeToggleBtn');
            if (btn) {
                const icon = btn.querySelector('span.material-symbols-rounded');
                if (icon) icon.textContent = isDark ? 'light_mode' : 'dark_mode';
                btn.title = isDark ? '切换为白色主题' : '切换为黑色主题';
            }

            // Mobile
            const mobileBtn = document.getElementById('mobileThemeToggleBtn');
            if (mobileBtn) {
                const icon = mobileBtn.querySelector('span.material-symbols-rounded');
                if (icon) icon.textContent = isDark ? 'light_mode' : 'dark_mode';
                // mobileBtn.textContent updates might be needed if text changes, but here we just change icon
            }
        }
        function toggleTheme() {
            const isDarkNow = document.documentElement.classList.toggle('dark');
            localStorage.setItem('gem_theme', isDarkNow ? 'dark' : 'light');
            updateThemeToggleIcon();
        }

        // Black & White toggle
        function updateBWToggleIcon() {
            const isBW = document.documentElement.classList.contains('bw');

            // Desktop
            const btn = document.getElementById('bwToggleBtn');
            if (btn) {
                const icon = btn.querySelector('span.material-symbols-rounded');
                if (icon) icon.textContent = isBW ? 'invert_colors_off' : 'invert_colors';
                btn.title = isBW ? '切换为彩色界面' : '切换为黑白界面';
            }

            // Mobile
            const mobileBtn = document.getElementById('mobileBwToggleBtn');
            if (mobileBtn) {
                const icon = mobileBtn.querySelector('span.material-symbols-rounded');
                if (icon) icon.textContent = isBW ? 'invert_colors_off' : 'invert_colors';
            }
        }
        function toggleBW() {
            const isBWNow = document.documentElement.classList.toggle('bw');
            localStorage.setItem('gem_bw', isBWNow ? '1' : '0');
            updateBWToggleIcon();
        }
        
        function renderContentParts(container, parts) {
            if(!parts) return;

            const lastImageIndexes = getLastImageIndexes(parts);
            const renderImage = (src) => {
                const imgDiv = document.createElement('div');
                imgDiv.className = "mt-3 relative group cursor-zoom-in";
                imgDiv.onclick = () => openLightbox(src);
                imgDiv.innerHTML = `
                    <img src="${src}" class="rounded-lg border border-gray-700 w-full object-contain max-h-[400px] bg-black/20 transition-transform group-hover:brightness-110">
                    <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                        <span class="bg-black/70 text-white px-3 py-1.5 rounded-full text-xs backdrop-blur flex items-center gap-1">
                            <span class="material-symbols-rounded text-sm">zoom_in</span>
                            点击放大
                        </span>
                    </div>
                `;
                container.appendChild(imgDiv);
            };

            parts.forEach((part, idx) => {
                if (part && typeof part.text === 'string' && part.text.length) {
                    const d = document.createElement('div');
                    // 优先使用 thought 标记来识别“思维链摘要”，对用户折叠展示
                    if (part.thought === true) {
                        d.innerHTML = `
                            <details class="text-xs text-gray-500 my-2">
                                <summary class="cursor-pointer">查看思维过程</summary>
                                <div class="prose prose-sm max-w-none prose-invert">${marked.parse(part.text)}</div>
                            </details>
                        `;
                    }
                    // 兼容旧版仅通过文本特征识别思维链内容的逻辑
                    else if (part.text.startsWith(" pensée")) {
                        const thoughtContent = part.text.substring(" pensée".length).trim();
                        d.innerHTML = `
                            <details class="text-xs text-gray-500 my-2">
                                <summary class="cursor-pointer">查看思维过程</summary>
                                <div class="prose prose-sm max-w-none prose-invert">${marked.parse(thoughtContent)}</div>
                            </details>
                        `;
                    } else if (part.text.includes("Tool Code:")) {
                        d.innerHTML = `
                            <details class="text-xs text-gray-500 my-2">
                                <summary class="cursor-pointer">查看思维过程</summary>
                                <div class="prose prose-sm max-w-none prose-invert">${marked.parse(part.text)}</div>
                            </details>
                        `;
                    } else {
                        d.innerHTML = marked.parse(part.text);
                    }
                    d.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
                    container.appendChild(d);
                }

                const src = getPartImageSource(part);
                if(lastImageIndexes.has(idx) && src) {
                    renderImage(src);
                }
            });
        }

        function escapeHtml(str = '') {
            return str.replace(/[&<>"']/g, (char) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[char] || char));
        }

        function truncateText(str = '', limit = 600) {
            if(str.length <= limit) return str;
            return str.slice(0, limit).trim() + '…';
        }

        function buildPreviewFromParts(parts = []) {
            const chunks = [];
            const orderedKeys = [];
            const imageMap = new Map();

            parts.forEach(part => {
                if (part && typeof part.text === 'string' && part.text.length) {
                    const rawText = part.text;
                    // 与 renderContentParts 保持一致：思维链内容不参与卡片预览文案
                    const isThought =
                        part.thought === true ||
                        rawText.startsWith(" pens&#233;e") ||
                        rawText.includes("Tool Code:");
                    if (!isThought) {
                        const trimmed = rawText.trim();
                        if (trimmed) chunks.push(trimmed);
                    }
                }

                const key = getPartImageKey(part);
                const src = getPartImageSource(part);
                if(key && src) {
                    if(imageMap.has(key)) {
                        const idx = orderedKeys.indexOf(key);
                        if(idx !== -1) orderedKeys.splice(idx, 1);
                    }
                    orderedKeys.push(key);
                    imageMap.set(key, src);
                }
            });

            const finalImages = orderedKeys.map(key => imageMap.get(key)).filter(Boolean);

            return { text: chunks.join('\n\n').trim(), hasImages: finalImages.length > 0, images: finalImages };
        }

        function renderCardPreview(sessionId) {
            const session = state.sessions[sessionId];
            const cardBody = document.getElementById(`body-${sessionId}`);
            if (!session || !cardBody) return;

            const modelMessages = session.messages.filter(m => m.role !== 'user');
            if (modelMessages.length === 0) {
                cardBody.innerHTML = `<div class="text-gray-500 text-xs font-mono">等待 AI 回复...</div>`;
                return;
            }

            const latest = modelMessages[modelMessages.length - 1];
            const preview = buildPreviewFromParts(latest.parts || []);

            const imageBadge = preview.hasImages
                ? `<span class="flex items-center gap-0.5 text-[10px] text-gray-400"><span class="material-symbols-rounded text-xs">image</span>图像</span>`
                : '';

            const imageSection = preview.images?.length
                ? `<div class="grid ${preview.images.length > 1 ? 'grid-cols-2' : 'grid-cols-1'} gap-3">
                        ${preview.images.map((src, idx) => {
                            const escapedSrc = escapeHtml(src);
                            const dataSrc = escapeHtml(encodeURIComponent(src));
                            return `
                                <div class="relative group rounded-lg border border-gray-700 bg-black/30 overflow-hidden cursor-zoom-in" data-preview-img="${dataSrc}" onclick="state.activeSessionId = '${sessionId}'; openLightbox(decodeURIComponent(this.dataset.previewImg));">
                                    <img src="${escapedSrc}" loading="lazy" class="w-full h-36 md:h-40 object-contain bg-black/20 transition-transform duration-200 group-hover:scale-[1.02]" alt="AI 输出图像 ${idx + 1}">
                                    <div class="absolute inset-0 flex items-center justify-center text-[10px] uppercase tracking-wider text-gray-200 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity">点击放大</div>
                                </div>
                            `;
                        }).join('')}
                   </div>`
                : '';

            cardBody.innerHTML = `
                <div class="space-y-3">
                    <div class="text-[11px] uppercase tracking-widest text-gray-500 flex items-center gap-2">
                        <span class="material-symbols-rounded text-sm text-blue-400">smart_toy</span>
                        AI 回复
                        ${imageBadge}
                    </div>
                    ${imageSection}
                    <button class="inline-flex items-center gap-1 text-xs text-blue-400 hover:text-blue-200 transition-colors" onclick="openChat('${sessionId}')">
                        查看完整回复
                        <span class="material-symbols-rounded text-base">north_east</span>
                    </button>
                </div>
            `;
        }
        function renderPreview() {
            dom.previewStrip.innerHTML = '';
            dom.previewStrip.classList.toggle('hidden', state.images.length === 0);
            dom.imgCount.textContent = state.images.length;
            dom.imgCount.classList.toggle('hidden', state.images.length === 0);
            state.images.forEach((img, idx) => {
                const isFirst = idx === 0;
                dom.previewStrip.innerHTML += `
                    <div class="relative w-16 h-16 flex-shrink-0 rounded border ${isFirst ? 'border-yellow-500 ring-2 ring-yellow-400' : 'border-gray-700'} bg-gray-800 group">
                        <img src="${img.b64}" class="w-full h-full object-cover rounded opacity-80 group-hover:opacity-100">
                        <span class="absolute -top-1 -left-1 text-[10px] font-bold bg-black/70 text-white px-1 rounded">${idx + 1}</span>
                        <div class="absolute inset-0 flex items-center justify-center bg-black/60 opacity-0 group-hover:opacity-100 text-white transition-opacity">
                            <div class="flex gap-1">
                                <button onclick="state.images.splice(${idx},1);renderPreview()" class="p-1 rounded bg-red-600/80 hover:bg-red-500" title="移除">
                                    <span class="material-symbols-rounded text-xs">close</span>
                                </button>
                                <button onclick="setFirstGlobalImage(${idx})" class="p-1 rounded bg-yellow-600/80 hover:bg-yellow-500" title="设为第一">
                                    <span class="material-symbols-rounded text-xs">looks_one</span>
                                </button>
                            </div>
                        </div>
                    </div>`;
            });
        }

        function openChat(id) {
            state.activeSessionId = id;
            dom.chatSessionId.textContent = `ID: ${id}`;
            dom.chatHistory.innerHTML = '';
            state.sessions[id].messages.forEach(msg => renderChatMessage(msg.role, msg.parts));
            toggleChatDrawer(true);
            setTimeout(() => dom.chatHistory.scrollTop = dom.chatHistory.scrollHeight, 100);
        }
        function toggleChatDrawer(open) {
            if(open) dom.chatDrawer.classList.remove('translate-x-full');
            else { dom.chatDrawer.classList.add('translate-x-full'); state.activeSessionId = null; }
        }
        async function sendChatMessage() {
            const txt = dom.chatInput.value.trim();
            if (!txt || !state.activeSessionId) return;

            const sessionId = state.activeSessionId;
            const session = state.sessions[sessionId];
            if (!session) return;

            session.messages.push({ role: 'user', parts: [{ text: txt }] });
            renderChatMessage('user', [{ text: txt }]);
            dom.chatInput.value = '';

            if (dom.sendChatBtn) {
                dom.sendChatBtn.disabled = true;
            }
            if (dom.chatStopBtn) {
                dom.chatStopBtn.disabled = false;
            }

            try {
                await executeSessionTurn(sessionId, null, false);
            } finally {
                if (dom.sendChatBtn) {
                    dom.sendChatBtn.disabled = false;
                }
                if (dom.chatStopBtn) {
                    dom.chatStopBtn.disabled = true;
                }
            }
        }

        function stopActiveChat() {
            if (!state.activeSessionId) return;
            stopSession(state.activeSessionId);
            if (dom.chatStopBtn) {
                dom.chatStopBtn.disabled = true;
            }
            if (dom.sendChatBtn) {
                dom.sendChatBtn.disabled = false;
            }
        }
        function renderChatMessage(role, parts) {
            const div = document.createElement('div');
            div.className = `flex ${role==='user'?'justify-end':'justify-start'} mb-4 animate-fade-in`;
            const bubble = document.createElement('div');
            bubble.className = role==='user' ? "bg-purple-900/30 border border-purple-800 text-gray-200 rounded-2xl rounded-tr-sm px-4 py-3 max-w-[90%] md:max-w-[85%]" : "bg-gray-800/50 border border-gray-700 text-gray-300 rounded-2xl rounded-tl-sm px-4 py-3 max-w-[90%] md:max-w-[85%] prose prose-invert prose-sm";
            renderContentParts(bubble, parts);
            div.appendChild(bubble);
            dom.chatHistory.appendChild(div);
            dom.chatHistory.scrollTop = dom.chatHistory.scrollHeight;
        }

        function disableStopButton(id) {
            const stopBtn = document.getElementById(`stop-${id}`);
            if (!stopBtn) return;
            stopBtn.disabled = true;
            stopBtn.classList.add('opacity-40', 'cursor-not-allowed');
        }

        function stopSession(id) {
            const session = state.sessions[id];
            if (!session || !session.abortController) return;
            try {
                session.abortController.abort();
            } catch (e) {}
            const statusEl = document.getElementById(`status-${id}`);
            if (statusEl) {
                statusEl.className = "mr-2 flex items-center gap-1 text-[10px] text-yellow-500 font-mono font-semibold stopped-status";
                statusEl.innerHTML = `<span class="material-symbols-rounded text-sm">do_not_disturb_on</span> 已停止`;
            }

            // 停止后移除卡片正文里的骨架加载动画，避免仍然显示“生成中”的流动条
            const bodyEl = document.getElementById(`body-${id}`);
            if (bodyEl && Array.isArray(session.messages)) {
                const hasModelMessage = session.messages.some(m => m.role !== 'user');
                // 只有在还没有任何模型回复时才覆盖成“已停止”提示，避免盖掉已有内容
                if (!hasModelMessage) {
                    bodyEl.innerHTML = `<div class="p-3 rounded text-xs font-mono stopped-banner">已停止，本次未生成结果。</div>`;
                }
            }

            disableStopButton(id);
            session.status = 'cancelled';
        }

        // Selection & Batch Logic
        function toggleSelection(id, checked) {
            if(checked) state.selectedSessions.add(id); else state.selectedSessions.delete(id);
            document.getElementById(`overlay-${id}`).classList.toggle('opacity-0', !checked);
            dom.selectedCount.textContent = state.selectedSessions.size;
            dom.selectionToolbar.classList.toggle('translate-y-32', state.selectedSessions.size === 0);
            dom.selectionToolbar.classList.toggle('opacity-0', state.selectedSessions.size === 0);
        }
        function clearSelection() {
            // 取消所有已选卡片的勾选与选中样式
            state.selectedSessions.forEach(id => {
                const checkbox = document.querySelector(`#card-${id} input[type="checkbox"]`);
                if (checkbox) checkbox.checked = false;
                const overlay = document.getElementById(`overlay-${id}`);
                if (overlay) overlay.classList.add('opacity-0');
            });

            // 清空选中集合
            state.selectedSessions.clear();

            // 重置计数并隐藏工具栏（与 toggleSelection 中 size === 0 的效果保持一致）
            dom.selectedCount.textContent = 0;
            dom.selectionToolbar.classList.add('translate-y-32');
            dom.selectionToolbar.classList.add('opacity-0');
        }
        function selectAll() {
            Object.keys(state.sessions).forEach(id => {
                const checkbox = document.querySelector(`#card-${id} input[type="checkbox"]`);
                if (checkbox && !checkbox.checked) {
                    checkbox.checked = true;
                    toggleSelection(id, true);
                }
            });
        }
        function deleteSession(id) { document.getElementById(`card-${id}`)?.remove(); delete state.sessions[id]; state.selectedSessions.delete(id); if(Object.keys(state.sessions).length===0) dom.emptyState.style.display='flex'; }
        function deleteSelected() { state.selectedSessions.forEach(deleteSession); clearSelection(); }
        
        function saveSelectedSessions() {
            const selectedIds = Array.from(state.selectedSessions);
            const count = selectedIds.length;
            if (count === 0) return alert("没有选中的对话。");

            const name = prompt(`为 ${count} 个对话输入一个集合名称:`, `集合 ${new Date().toLocaleTimeString()}`);
            if (!name) return;

            // Build raw sessions snapshot（直接引用运行时 session，确保图片文件名在导出 ZIP 时保持一致）
            const rawSessions = [];
            selectedIds.forEach(id => {
                const session = state.sessions[id];
                if (session) {
                    rawSessions.push({
                        timestamp: session.timestamp,
                        messages: session.messages,
                        systemInstruction: session.systemInstruction
                    });
                }
            });

            // Pack (deduplicate) images before persisting to avoid localStorage配额问题
            const packed = packCollectionSessions(rawSessions);
            const collection = {
                id: Date.now(),
                name,
                sessions: packed.sessions,
                assets: packed.assets,
                v: packed.v
            };

            // Persist with safety
            state.collections.unshift(collection);
            try {
                localStorage.setItem('gem_collections_v1.0', JSON.stringify(state.collections));
                alert(`包含 ${count} 个对话的合集已保存!`);
            } catch (e) {
                // 回滚内存里的插入，防止与磁盘状态不一致
                state.collections.shift();
                console.error('保存合集到 localStorage 失败:', e);
                alert('保存失败：数据体积过大。请尝试减少图片数量，或使用“库→导出”备份到文件。');
            }

            // 自动导出合集所包含对话的图片为 ZIP（包含 save image 文件夹）
            const safeBaseName = (name || '').replace(/[\\/:*?"<>|]+/g, '_').trim() || `collection_${collection.id}`;
            exportImagesForSessions(selectedIds, `collection_${safeBaseName}`).catch(e => console.error('导出合集图片失败', e));

            clearSelection();
        }

        function viewRaw(id) {
            const s = state.sessions[id];
            if(!s?.lastRaw) return;
            dom.rawReqCode.textContent = JSON.stringify(s.lastRaw.req, null, 2);
            dom.rawResCode.textContent = JSON.stringify(s.lastRaw.res, null, 2);
            hljs.highlightElement(dom.rawReqCode);
            hljs.highlightElement(dom.rawResCode);
            toggleRawModal(true);
        }
        function toggleRawModal(show) { dom.rawModal.classList.toggle('hidden', !show); }
        function openLightbox(src) {
            state.currentLightboxSrc = src;
            dom.lightboxImg.src = src;
            dom.lightbox.classList.remove('hidden');
            setTimeout(() => {
                dom.lightbox.classList.remove('opacity-0');
                dom.lightboxImg.classList.remove('scale-95');
                dom.lightboxImg.classList.add('scale-100');
            }, 10);
        }
        function closeLightbox() {
            dom.lightbox.classList.add('opacity-0');
            dom.lightboxImg.classList.add('scale-95');
            dom.lightboxImg.classList.remove('scale-100');
            setTimeout(() => {
                dom.lightbox.classList.add('hidden');
                dom.lightboxImg.src = '';
                state.currentLightboxSrc = null;
            }, 300);
        }
        function downloadCurrentLightboxImage() { const a=document.createElement('a'); a.href=state.currentLightboxSrc; a.target = '_blank'; a.download=`img_${Date.now()}.png`; a.click(); }

        document.addEventListener('keydown', (e) => {
            if (dom.lightbox.classList.contains('hidden')) return;

            if (e.key === 'ArrowLeft') {
                // Find current image in the session and move to the previous one
                navigateLightbox(-1);
            } else if (e.key === 'ArrowRight') {
                // Find current image in the session and move to the next one
                navigateLightbox(1);
            }
        });

        function navigateLightbox(direction) {
            if (!state.currentLightboxSrc) return;

            // 收集当前画布所有对话卡片里的模型图片，按卡片显示顺序 + 消息顺序排列
            const cards = Array.from(dom.grid.querySelectorAll('[id^="card-"]'));
            const globalImages = [];

            cards.forEach(card => {
                const sessionId = card.id.replace(/^card-/, '');
                const session = state.sessions[sessionId];
                if (!session || !Array.isArray(session.messages)) return;

                session.messages.forEach(msg => {
                    if (msg.role === 'model' && Array.isArray(msg.parts)) {
                        msg.parts.forEach(part => {
                            const src = getPartImageSource(part);
                            if (src) {
                                globalImages.push({ sessionId, src });
                            }
                        });
                    }
                });
            });

            if (globalImages.length <= 1) return;

            // 优先使用 (sessionId + src) 精确定位当前图片在全局序列中的位置
            let currentIndex = globalImages.findIndex(img =>
                img.src === state.currentLightboxSrc &&
                img.sessionId === state.activeSessionId
            );

            // 兜底：如果 activeSessionId 未设置或不匹配，则仅按 src 匹配
            if (currentIndex === -1) {
                currentIndex = globalImages.findIndex(img => img.src === state.currentLightboxSrc);
                if (currentIndex === -1) return;
            }

            let nextIndex = currentIndex + direction;

            if (nextIndex < 0) {
                nextIndex = globalImages.length - 1;
            } else if (nextIndex >= globalImages.length) {
                nextIndex = 0;
            }

            const next = globalImages[nextIndex];
            // 更新当前会话为目标图片所在的对话，实现“跨对话”切换
            state.activeSessionId = next.sessionId;
            openLightbox(next.src);
        }
        
        async function downloadSelectedImages() {
            // 复用通用导出函数，将当前选中对话的图片打成 ZIP
            const selectedIds = Array.from(state.selectedSessions);
            if (!selectedIds.length) {
                return alert("没有找到可下载的图片。");
            }
            await exportImagesForSessions(selectedIds, "images");
        }

        async function exportImagesForSessions(sessionIds, baseName = "images") {
            const zip = new JSZip();
            let imagePromises = [];

            sessionIds.forEach(id => {
                const session = state.sessions[id];
                if (!session || !Array.isArray(session.messages)) return;

                session.messages
                    .filter(m => m.role === 'model')
                    .forEach(m => {
                        m.parts?.forEach((p, i) => {
                            const inlineData = p.inline_data || p.inlineData;
                            const fileData = p.file_data || p.fileData;

                            if (inlineData && inlineData.data) {
                                // 与 makeMessagesStorageSafe 中保存到库里的 file_uri 使用同一套命名规则
                                const info = getInlineImageFilename(p);
                                const inlineMime = inlineData.mime_type || inlineData.mimeType || 'image/png';
                                const ext = (inlineMime.split('/')[1] || 'png').toLowerCase();
                                const filename = (info && info.filename) ? info.filename : `save image/inline_${id}_${i}.${ext}`;
                                const data = normalizeBase64(inlineData.data);
                                zip.file(filename, data, { base64: true });
                            } else if (fileData && fileData.file_uri) {
                                const url = fileData.file_uri;
                                const extMatch = url.match(/\.([^.?]+)(?:\?.*)?$/);
                                const ext = extMatch ? extMatch[1] : 'png';

                                if (url.startsWith('data:')) {
                                    try {
                                        const parts = url.split(',');
                                        const meta = parts[0];
                                        const data = parts[1];
                                        const mimeMatch = meta.match(/:(.*?);/);
                                        const mime = mimeMatch ? mimeMatch[1] : 'image/png';
                                        const extFromMime = (mime.split('/')[1] || 'png').toLowerCase();
                                        zip.file(`save image/${id}_${i}.${extFromMime}`, data, { base64: true });
                                    } catch(e) {
                                        console.error("Error parsing data URL:", url, e);
                                        zip.file(`save image/${id}_${i}_urldata.txt`, url);
                                    }
                                } else {
                                    const promise = fetch(url)
                                        .then(response => {
                                            if (!response.ok) throw new Error(`Network response was not ok for ${url}`);
                                            return response.blob();
                                        })
                                        .then(blob => {
                                            zip.file(`save image/${id}_${i}.${ext}`, blob);
                                        })
                                        .catch(err => {
                                            console.error(`Fetch failed for ${url}, saving URL as .txt file instead. Error:`, err);
                                            zip.file(`save image/${id}_${i}_fallback.txt`, url);
                                        });
                                    imagePromises.push(promise);
                                }
                            }
                        });
                    });
            });

            // Wait for all remote images to be fetched
            await Promise.all(imagePromises);

            if (Object.keys(zip.files).length === 0) {
                return alert("没有找到可下载的图片。");
            }

            const blob = await zip.generateAsync({ type: "blob" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            a.download = `${baseName}_${timestamp}.zip`;
            a.click();
            URL.revokeObjectURL(a.href);
        }
        async function fetchModels() {
            const currentModel = dom.modelId.value; // 保存当前值
            dom.modelId.blur(); // 强制输入框失焦，关闭建议列表
            try {
                dom.modelId.value = ''; // 临时清空以确保datalist在填充时不会被过滤

                const apiFormat = state.apiFormat || 'gemini';
                const base = dom.baseUrl.value.replace(/\/$/, '');
                let url = '';
                const fetchOptions = { method: 'GET', headers: {} };

                if (apiFormat === 'openai') {
                    // OpenAI 官方接口：GET /v1/models，使用 Bearer 鉴权
                    const ver = dom.apiVersion.value.trim() || 'v1';
                    url = `${base}/${ver}/models`;
                    fetchOptions.headers['Authorization'] = `Bearer ${dom.apiKey.value}`;
                } else if (apiFormat === 'vertex') {
                    // Vertex 模式下模型列表接口较复杂，这里先提示手动填写，避免错误请求
                    alert('Vertex 通道暂不支持自动获取模型列表，请手动填写模型 ID。');
                    dom.modelId.value = currentModel;
                    return;
                } else {
                    // 默认按 Gemini 官方接口处理
                    url = `${base}/v1beta/models?key=${dom.apiKey.value}`;
                }

                const res = await fetch(url, fetchOptions);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                const modelListEl = document.getElementById('modelList');
                if (modelListEl) {
                    if (apiFormat === 'openai') {
                        const list = data.data || data.models || [];
                        modelListEl.innerHTML = list
                            .map(m => {
                                const id = (m.id || m.name || '').replace(/^models\//, '');
                                return id ? `<option value="${id}"></option>` : '';
                            })
                            .join('');
                    } else {
                        modelListEl.innerHTML = (data.models || [])
                            .map(m => `<option value="${m.name.replace('models/','')}"></option>`)
                            .join('');
                    }
                }
                alert("模型列表已更新");
            } catch (e) {
                console.error("获取模型列表失败:", e);
                alert("获取失败: " + e.message);
            } finally {
                dom.modelId.value = currentModel; // 恢复原值
            }
        }
    </script>
</body>
</html>